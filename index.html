<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lipton Legal - Legal Forms Portal</title>
    <!--
        Lipton Legal - Professional Legal Forms Portal

        This application provides multiple legal intake forms for different purposes:

        1. DOCUMENT GENERATION FORM (Main Form):
           - Collects plaintiff and defendant information for legal proceedings
           - Dynamic addition/removal of plaintiffs and defendants
           - Smart section headers that display names when available
           - Conditional sections for head of household information with comprehensive issue tracking
           - Real-time "At a Glance" case summary with filing metadata and party counts
           - Comprehensive issue categories with expandable sections

        2. HABITABILITY INTAKE FORM (New):
           - Comprehensive habitability complaint intake form
           - Collects personal information, address, and client details
           - Household and building information tracking
           - Detailed building issues assessment (electrical, plumbing, HVAC, etc.)
           - Common area issues tracking with checkbox grid
           - Pest/vermin issue reporting with multiple pest types
           - Health and safety hazards documentation
           - Landlord/property manager conduct tracking
           - Neighbor/tenant involvement assessment
           - Document upload capabilities for evidence
           - Submission tracking and case assignment

        3. VIEW SUBMISSIONS TAB:
           - View all form submissions from both forms
           - Search, sort, and filter capabilities
           - Statistics dashboard

        Features:
        - Enhanced clickable areas for better user experience
        - Professional styling aligned with Lipton Legal brand guidelines
        - Responsive design for all devices
        - Custom styled confirmation modal before form submission
        - Inline validation with live success/error feedback for required fields
        - File upload support for documents and evidence

        Brand Colors:
        - Primary Navy: #1F2A44 (headers, buttons)
        - Secondary Teal: #00AEEF (accents, add buttons)
        - Neutral Gray: #F5F5F5 (backgrounds)
        - Text: #333333 (body text)

        User Experience Enhancements:
        - Large clickable areas for checkboxes and radio buttons
        - Category headers are fully clickable to expand/collapse sections
        - Visual feedback on hover states
        - Comprehensive issue tracking with proper categorization
        - Custom styled confirmation modal matching brand design
        - Tab-based navigation for easy access to different forms

        Last Updated: 2025-10-14
        - Renamed "Form Submission" tab to "Document Generation Form"
        - Added new "Habitability Intake Form" tab with comprehensive field collection
        - Implemented full form structure based on Habitability Intake Form Fields specification
        - Added JavaScript handlers for new habitability form submission
        - Updated showTab() function to support three tabs: form, habitability, submissions
        - Maintained consistent styling across all forms
        - Added inline documentation for new features

        Previous Updates (2025-10-07):
        - Enhanced plaintiff section usability with dynamic section titles
        - Enhanced At a Glance summary section with bold metadata labels
        - Replaced complex review screen with custom confirmation modal
        - Converted repeatable blocks and issue categories into aria-synced accordion controls
    -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            line-height: 1.4;
            margin: 0;
            padding: 10px;
            background: #F5F5F5;
            min-height: 100vh;
            color: #333333;
        }

        .form-container {
            /* Enforce centered, full-width shell while honoring overall 1000px design limit */
            width: 100%;
            max-width: var(--form-shell-width);
            margin: 0 auto;
            background: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(31, 42, 68, 0.15);
            overflow: visible;
            border: 1px solid #E2E8F0;
        }

        .form-header {
            background: linear-gradient(135deg, #1F2A44 0%, #2A3B5A 100%);
            color: #FFFFFF;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .form-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #00AEEF 0%, #F2C8D0 100%);
        }

        .form-header .logo {
            height: 80px;
            width: auto;
            filter: brightness(0) invert(1);
        }

        .form-header .header-text {
            text-align: left;
        }

        .form-header h1 {
            margin: 0;
            font-family: 'Open Sans', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: #FFFFFF;
            letter-spacing: 0.5px;
        }

        .form-header .subtitle {
            margin: 4px 0 0 0;
            font-size: 0.9rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
            font-family: 'Open Sans', sans-serif;
        }

        :root {
            --form-shell-width: 1000px;
            --summary-width: 320px;
            --summary-gap: 30px;
            --stepper-width: 240px;
        }

        .page-layout {
            display: block;
            padding: 20px;
            width: 100%;
            margin: 0 auto;
        }

        .form-content {
            padding: 20px;
        }

        .summary-panel {
            background: #FFFFFF;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(31, 42, 68, 0.08);
            width: 100%;
            max-width: 100%;
            margin-top: 20px;
        }

        .progress-sidebar {
            background: #FFFFFF;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(31, 42, 68, 0.08);
            margin-bottom: 20px;
        }

        .progress-sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .stepper-toggle {
            border: 1px solid #E2E8F0;
            background: #FFFFFF;
            color: #1F2A44;
            border-radius: 20px;
            padding: 6px 10px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .stepper-toggle:hover {
            border-color: #00AEEF;
            color: #0F172A;
            box-shadow: 0 2px 6px rgba(31, 42, 68, 0.12);
        }

        .show-stepper-button {
            border: 1px solid #E2E8F0;
            background: #FFFFFF;
            color: #1F2A44;
            border-radius: 20px;
            padding: 10px 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            box-shadow: 0 2px 6px rgba(31, 42, 68, 0.12);
            transition: all 0.2s ease;
            width: 100%;
            margin: 16px 0 0 0;
        }

        .show-stepper-button:hover {
            border-color: #00AEEF;
            color: #0F172A;
            box-shadow: 0 4px 10px rgba(31, 42, 68, 0.12);
        }

        .show-stepper-button i {
            font-size: 0.9rem;
        }

        .progress-sidebar.stepper-collapsed {
            padding: 12px;
        }

        .progress-sidebar.stepper-collapsed .progress-sidebar-header,
        .progress-sidebar.stepper-collapsed .stepper-list {
            display: none;
        }

        .progress-sidebar.stepper-collapsed .show-stepper-button {
            margin: 0;
        }

        .progress-sidebar h3 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #1F2A44;
        }

        .stepper-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .stepper-list::-webkit-scrollbar {
            display: none;
        }

        .stepper-item {
            flex: 0 0 auto;
        }

        .stepper-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #E2E8F0;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1F2A44;
            text-decoration: none;
            background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
            transition: all 0.2s ease;
            min-width: 160px;
        }

        .stepper-link:hover {
            border-color: #00AEEF;
            box-shadow: 0 2px 6px rgba(31, 42, 68, 0.12);
        }

        .stepper-link.active {
            border-color: #00AEEF;
            background: linear-gradient(135deg, rgba(0, 174, 239, 0.12) 0%, rgba(0, 174, 239, 0.05) 100%);
            color: #0F172A;
            box-shadow: 0 4px 10px rgba(31, 42, 68, 0.12);
        }

        .stepper-circle {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .stepper-label {
            white-space: nowrap;
        }

        .summary-panel h3 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            color: #1F2A44;
        }

        .summary-panel p {
            margin: 0 0 15px 0;
            font-size: 0.85rem;
            color: #5B6475;
        }

        .summary-grid {
            display: grid;
            gap: 15px;
        }

        .summary-list {
            margin-bottom: 10px;
        }

        .summary-list:last-child {
            margin-bottom: 0;
        }

        .summary-list-title {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1F2A44;
            margin-bottom: 4px;
        }

        .summary-list-items {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 4px;
        }

        .summary-list-items li {
            font-size: 0.85rem;
            color: #1F2A44;
        }

        .summary-list-items li .summary-star {
            color: #E53E3E;
            margin-left: 4px;
        }

        .summary-empty {
            font-style: italic;
            color: #5B6475;
        }

        .summary-footnote {
            font-size: 0.75rem;
            color: #5B6475;
            margin: 10px 0 0 0;
        }

        .summary-card {
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            padding: 12px;
            background: #F8FAFC;
        }

        .summary-card h4 {
            margin: 0 0 6px 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: #1F2A44;
        }

        .summary-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1F2A44;
        }

        .summary-subvalue {
            font-size: 0.85rem;
            color: #5B6475;
        }

        @media (min-width: 992px) {
            .page-layout {
                display: grid;
                /* Three-column scaffold keeps the form shell anchored to the center column */
                grid-template-columns: minmax(0, 1fr) minmax(0, var(--form-shell-width)) minmax(0, 1fr);
                column-gap: 24px;
                align-items: start;
            }

            .progress-sidebar {
                grid-column: 1;
                justify-self: end;
                position: sticky;
                top: 20px;
                align-self: start;
                width: min(var(--stepper-width), 100%);
                max-width: var(--stepper-width);
            }

            /* Center column always hosts the form shell */
            .form-container {
                grid-column: 2;
                margin: 0;
                justify-self: center;
                width: 100%;
            }

            .summary-panel {
                grid-column: 3;
                max-width: var(--summary-width);
                width: 100%;
                justify-self: start;
                position: sticky;
                top: 20px;
                align-self: start;
            }

            .stepper-list {
                flex-direction: column;
                gap: 8px;
                overflow: visible;
            }

            .stepper-item {
                flex: 1 1 auto;
            }

            .stepper-link {
                min-width: unset;
            }
        }

        @media (min-width: 1360px) {
            .page-layout {
                column-gap: var(--summary-gap);
            }
        }

        .section {
            margin-bottom: 15px;
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            overflow: hidden;
            background: #FFFFFF;
            box-shadow: 0 2px 8px rgba(31, 42, 68, 0.08);
        }

        .section-header {
            background: linear-gradient(135deg, #F5F5F5 0%, #FFFFFF 100%);
            padding: 15px 20px;
            border-bottom: 2px solid #1F2A44;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .section-header::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #00AEEF;
        }

        .section-title {
            font-family: 'Open Sans', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: #1F2A44;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-content {
            padding: 15px;
        }

        .repeatable-section {
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #FFFFFF;
            box-shadow: 0 1px 4px rgba(31, 42, 68, 0.1);
            transition: box-shadow 0.3s ease;
        }

        .repeatable-header {
            background: linear-gradient(135deg, #F5F5F5 0%, #E2E8F0 100%);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1F2A44;
            gap: 12px;
        }

        .repeatable-toggle {
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: #1F2A44;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            padding: 8px 4px;
            flex: 1;
            text-align: left;
        }

        .repeatable-toggle:focus-visible {
            outline: 2px solid #00AEEF;
            outline-offset: 2px;
        }

        .repeatable-title {
            margin: 0;
        }

        .repeatable-indicator {
            color: #1F2A44;
            transition: transform 0.2s ease;
        }

        .repeatable-section.is-collapsed .repeatable-indicator {
            transform: rotate(-90deg);
        }

        .repeatable-content {
            padding: 12px;
        }

        .repeatable-content[hidden] {
            display: none;
        }

        .repeatable-collapse-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
            gap: 8px;
        }

        .repeatable-collapse-toggle {
            background: #FFFFFF;
            color: #1F2A44;
            border: 1px solid #CBD5E1;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.82rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .repeatable-collapse-toggle:hover {
            background: #E2E8F0;
            border-color: #94A3B8;
        }

        .repeatable-collapse-toggle:focus-visible {
            outline: 2px solid #00AEEF;
            outline-offset: 2px;
        }


        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group.required label {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .form-group .required-marker {
            color: #E53E3E;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .form-group .validation-message {
            margin-top: 6px;
            font-size: 0.78rem;
            font-weight: 600;
            color: #E53E3E;
        }

        .form-group.has-error input,
        .form-group.has-error select,
        .form-group.has-error textarea {
            border-color: #E53E3E;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.15);
        }

        .form-group.has-success input,
        .form-group.has-success select,
        .form-group.has-success textarea {
            border-color: #38A169;
            box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.2);
        }

        .form-group.has-success .validation-message {
            color: #38A169;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1F2A44;
            font-size: 0.9rem;
            font-family: 'Open Sans', sans-serif;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: #FFFFFF;
            font-family: 'Open Sans', sans-serif;
            color: #333333;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00AEEF;
            box-shadow: 0 0 0 3px rgba(0, 174, 239, 0.15);
            background: #FFFFFF;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #FFFFFF;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .checkbox-item:hover {
            border-color: #00AEEF;
            background: linear-gradient(135deg, #F5F5F5 0%, #FFFFFF 100%);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: auto;
        }

        .issue-categories-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .toggle-section {
            margin-bottom: 0;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            overflow: hidden;
            background: #FFFFFF;
            box-shadow: 0 2px 8px rgba(31, 42, 68, 0.08);
        }

        .toggle-section.span-both {
            grid-column: 1 / -1;
        }

        .toggle-header {
            background: linear-gradient(135deg, #F5F5F5 0%, #FFFFFF 100%);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .toggle-header:hover,
        .toggle-header:focus-within {
            background: linear-gradient(135deg, #E2E8F0 0%, #F5F5F5 100%);
            border-left-color: #00AEEF;
        }

        .toggle-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-checkbox input[type="checkbox"] {
            width: auto;
            transform: scale(1.15);
            cursor: pointer;
        }

        .toggle-checkbox label {
            font-weight: 600;
            color: #1F2A44;
            cursor: pointer;
            margin: 0;
            font-size: 0.9rem;
        }

        .toggle-button {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex: 1;
            cursor: pointer;
            padding: 6px 0;
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: #1F2A44;
            text-align: left;
        }

        .toggle-button:focus-visible {
            outline: 2px solid #00AEEF;
            outline-offset: 2px;
        }

        .toggle-indicator {
            transition: transform 0.2s ease;
        }

        .toggle-button[aria-expanded="false"] .toggle-indicator {
            transform: rotate(-90deg);
        }

        .toggle-content {
            display: none;
            padding: 12px;
            background: #FFFFFF;
        }

        .toggle-content.show {
            display: block;
        }

        .toggle-content[hidden] {
            display: none;
        }

        .btn {
            background: #1F2A44;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: 'Open Sans', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(31, 42, 68, 0.2);
        }

        .btn:hover {
            background: #2A3B5A;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(31, 42, 68, 0.3);
        }

        .btn-remove {
            background: #DC3545;
            color: #FFFFFF;
            padding: 10px;
            min-width: auto;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .btn-remove:hover {
            background: #C82333;
            transform: translateY(-2px);
        }

        .btn-add {
            background: #00AEEF;
            margin-top: 10px;
            color: #FFFFFF;
        }

        .btn-add:hover {
            background: #0091CC;
            transform: translateY(-2px);
        }

        .conditional-section {
            margin-top: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #F5F5F5 0%, #FFFFFF 100%);
            border-radius: 6px;
            border-left: 3px solid #00AEEF;
            box-shadow: 0 1px 4px rgba(31, 42, 68, 0.1);
        }

        .conditional-section h4 {
            margin: 0 0 8px 0;
            font-size: 1rem;
            font-weight: 600;
            color: #1F2A44;
        }

        .hidden {
            display: none;
        }

        /* Confirmation Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 0;
            max-width: 800px;
            max-height: 90vh;
            width: 90%;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(31, 42, 68, 0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            background: linear-gradient(135deg, #1F2A44 0%, #2A3B5A 100%);
            color: #FFFFFF;
            padding: 20px;
            text-align: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #E2E8F0;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* Custom Confirmation Modal Styles */
        .confirmation-modal {
            max-width: 550px;
        }

        .confirmation-checklist {
            background: #F8FAFC;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-item i {
            color: #00AEEF;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .checklist-item span {
            color: #1F2A44;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .confirmation-note {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 12px 15px;
            border-radius: 6px;
        }

        .confirmation-note i {
            color: #D97706;
            font-size: 1.1rem;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .confirmation-note span {
            color: #92400E;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .modal-error {
            color: #E53E3E;
            font-size: 0.9rem;
            margin-top: 12px;
            text-align: center;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-primary {
            background: #28a745;
            color: white;
        }

        .btn-primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .confirmation-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #F5F5F5;
            border-radius: 8px;
            border-left: 4px solid #00AEEF;
        }

        .confirmation-section h3 {
            margin: 0 0 10px 0;
            color: #1F2A44;
            font-size: 1.1rem;
        }

        .confirmation-item {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .confirmation-item:last-child {
            border-bottom: none;
        }

        .confirmation-label {
            font-weight: 600;
            color: #1F2A44;
            display: inline-block;
            min-width: 150px;
        }

        .confirmation-value {
            color: #333333;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .direct-issues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 6px;
            margin-top: 10px;
        }

        .direct-issue-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #FFFFFF;
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .direct-issue-item:hover {
            border-color: #00AEEF;
            background: linear-gradient(135deg, #F5F5F5 0%, #FFFFFF 100%);
        }

        .direct-issue-item label {
            display: flex;
            align-items: center;
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .direct-issue-item input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .radio-group.inline {
            display: inline-flex;
            gap: 15px;
            margin-top: 5px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid #E2E8F0;
            background: #FFFFFF;
        }

        .radio-item:hover {
            background-color: rgba(0, 174, 239, 0.1);
            border-color: #00AEEF;
        }

        .radio-item input[type="radio"] {
            margin: 0;
            transform: scale(1.1);
        }

        .radio-item label {
            margin: 0;
            font-weight: normal;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .form-group.unit-field {
            max-width: 150px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: #F5F5F5;
            border-bottom: 2px solid #E2E8F0;
            padding: 0 30px;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: #E2E8F0;
            color: #1F2A44;
        }

        .nav-tab.active {
            background: #FFFFFF;
            color: #1F2A44;
            border-bottom: 3px solid #00AEEF;
        }

        .nav-tab i {
            margin-right: 8px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Submissions Tab Styles */
        .submissions-content {
            padding: 20px;
        }

        .submissions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #E2E8F0;
        }

        .submissions-header h2 {
            margin: 0;
            color: #1F2A44;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn-refresh {
            background: #00AEEF;
            font-size: 0.9rem;
            padding: 10px 18px;
        }

        .btn-refresh:hover {
            background: #0091CC;
        }

        .submissions-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #FFFFFF;
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(31, 42, 68, 0.08);
            border-left: 4px solid #00AEEF;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1F2A44;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .submissions-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            gap: 20px;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: 'Open Sans', sans-serif;
        }

        .search-box input:focus {
            border-color: #00AEEF;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 174, 239, 0.15);
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .sort-controls select {
            padding: 12px 15px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
            background: #FFFFFF;
            cursor: pointer;
        }

        .sort-controls select:focus {
            border-color: #00AEEF;
            outline: none;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        .loading-spinner i {
            font-size: 1.5rem;
            margin-right: 10px;
            color: #00AEEF;
        }

        .submissions-list {
            overflow-x: auto;
        }

        .submissions-table {
            width: 100%;
            border-collapse: collapse;
            background: #FFFFFF;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(31, 42, 68, 0.08);
        }

        .submissions-table thead {
            background: #1F2A44;
            color: white;
        }

        .submissions-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid #E2E8F0;
        }

        .submissions-table td {
            padding: 12px;
            border-bottom: 1px solid #E2E8F0;
            vertical-align: middle;
        }

        .submissions-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .submissions-table tbody tr:hover {
            background-color: #F8FAFC;
        }

        .submissions-table tbody tr:last-child td {
            border-bottom: none;
        }

        .street-address-cell {
            font-weight: 600;
            color: #1F2A44;
            min-width: 200px;
        }

        .actions-cell {
            white-space: nowrap;
            width: 140px;
        }

        .actions-cell .btn-small {
            margin-right: 5px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 5px;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }


        .btn-view {
            background: #00AEEF;
            color: white;
        }

        .btn-view:hover {
            background: #0091CC;
        }

        .btn-delete {
            background: #DC3545;
            color: white;
        }

        .btn-delete:hover {
            background: #C82333;
        }

        .no-submissions {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-submissions i {
            font-size: 4rem;
            color: #E2E8F0;
            margin-bottom: 20px;
        }

        .no-submissions h3 {
            margin: 0 0 10px 0;
            font-size: 1.3rem;
            color: #1F2A44;
        }

        .no-submissions p {
            margin: 0;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .direct-issues-grid {
                grid-template-columns: 1fr;
            }

            .issue-categories-grid {
                grid-template-columns: 1fr;
            }

            .form-content {
                padding: 15px;
            }

            .nav-tabs {
                padding: 0 15px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 0.85rem;
            }

            .submissions-content {
                padding: 15px;
            }

            .submissions-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: none;
                margin-bottom: 15px;
            }

            .submissions-stats {
                grid-template-columns: 1fr;
            }

            .submissions-table {
                font-size: 0.8rem;
            }

            .submissions-table th,
            .submissions-table td {
                padding: 8px 6px;
            }

            .street-address-cell {
                min-width: 150px;
            }

            .actions-cell {
                width: 100px;
            }

            .btn-small {
                padding: 4px 8px;
                font-size: 0.7rem;
            }

            .btn-icon {
                width: 28px;
                height: 28px;
                padding: 6px;
            }
        }

        /* Edit form styles */
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background-color: #ffffff;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .col {
            flex: 1;
        }

        .col label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2D3748;
            font-size: 14px;
        }

        .edit-person-container {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
        }

        /* Removed pipeline toast UI styles */
    </style>
</head>
<body>
    

    <div class="page-layout summary-visible">
        <nav id="progress-sidebar" class="progress-sidebar" aria-label="Form steps" aria-hidden="false">
            <div class="progress-sidebar-header">
                <h3>Form Steps</h3>
                <button type="button" id="hide-stepper-button" class="stepper-toggle" aria-label="Hide Form Steps">
                    <i class="fa-solid fa-eye-slash" aria-hidden="true"></i>
                </button>
            </div>
            <ol class="stepper-list">
                <li class="stepper-item">
                    <a class="stepper-link" href="#section-property">
                        <span class="stepper-circle">1</span>
                        <span class="stepper-label">Property Details</span>
                    </a>
                </li>
                <li class="stepper-item">
                    <a class="stepper-link" href="#section-plaintiff">
                        <span class="stepper-circle">2</span>
                        <span class="stepper-label">Plaintiffs</span>
                    </a>
                </li>
                <li class="stepper-item">
                    <a class="stepper-link" href="#section-defendant">
                        <span class="stepper-circle">3</span>
                        <span class="stepper-label">Defendants</span>
                    </a>
                </li>
                <li class="stepper-item">
                    <a class="stepper-link" href="#section-submit">
                        <span class="stepper-circle">4</span>
                        <span class="stepper-label">Review & Submit</span>
                    </a>
                </li>
            </ol>
            <button type="button" id="show-stepper-button" class="show-stepper-button hidden" aria-label="Show Form Steps" aria-hidden="true">
                <i class="fa-solid fa-eye" aria-hidden="true"></i>
                <span>Show Steps</span>
            </button>
        </nav>
        <div class="form-container">
        <div class="form-header">
            <img src="logo.png" alt="Lipton Legal Logo" class="logo">
            <div class="header-text">
                <h1>Discovery Document Generation Form</h1>
                <p class="subtitle">Professional Legal Services</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('form')">
                <i class="fas fa-file-alt"></i> Document Generation Form
            </button>
            <button class="nav-tab" onclick="showTab('submissions')">
                <i class="fas fa-list"></i> View Submissions
            </button>
        </div>

        <!-- Form Tab Content -->
        <div id="form-tab" class="tab-content active">
            <div class="form-content">
                <form id="main-form" class="form-main">
                <!-- Section 1: Address of the Property -->
                <div class="section" id="section-property">
                    <div class="section-header">
                        <h2 class="section-title">1. Address of the Property</h2>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div style="grid-column: 1 / -1; display: grid; grid-template-columns: 1fr auto; gap: 15px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="property-address">Property Address (Line 1):</label>
                                    <input type="text" id="property-address" name="property-address" placeholder="Enter street address" required>
                                </div>
                                <div class="form-group" style="margin-bottom: 0; max-width: 250px;">
                                    <label for="apartment-unit">Unit Number:</label>
                                    <input type="text" id="apartment-unit" name="apartment-unit" placeholder="Optional">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="city">City:</label>
                                <input type="text" id="city" name="city" placeholder="Enter city" required>
                            </div>
                            <div class="form-group">
                                <label for="state">State:</label>
                                <select id="state" name="state" required>
                                    <option value="">Select a state</option>
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OH">Ohio</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="zip-code">ZIP Code:</label>
                                <input type="text" id="zip-code" name="zip-code" pattern="[0-9]{5}(-[0-9]{4})?" title="Please enter a valid ZIP code (e.g., 12345 or 12345-6789)" placeholder="12345" required>
                            </div>
                            <div class="form-group">
                                <label for="filing-city">Filing City:</label>
                                <input type="text" id="filing-city" name="filing-city" placeholder="Enter filing city" required>
                            </div>
                            <div class="form-group">
                                <label for="filing-county">Filing County:</label>
                                <input type="text" id="filing-county" name="filing-county" placeholder="Enter filing county" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Plaintiff Details -->
                <div class="section" id="section-plaintiff">
                    <div class="section-header">
                        <h2 class="section-title">2. Plaintiff Details</h2>
                        <button type="button" class="repeatable-collapse-toggle" data-target="plaintiffs-container" data-state="expanded" aria-pressed="true" onclick="toggleAllRepeatables('plaintiffs-container', this)">
                            Collapse All
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="plaintiffs-container">
                            <!-- Plaintiffs will be added here dynamically -->
                        </div>
                        <button type="button" class="btn btn-add" onclick="addPlaintiff()"><i class="fas fa-plus"></i> Add Plaintiff</button>
                    </div>
                </div>

                <!-- Section 3: Defendant Details -->
                <div class="section" id="section-defendant">
                    <div class="section-header">
                        <h2 class="section-title">3. Defendant Details</h2>
                        <button type="button" class="repeatable-collapse-toggle" data-target="defendants-container" data-state="expanded" aria-pressed="true" onclick="toggleAllRepeatables('defendants-container', this)">
                            Collapse All
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="defendants-container">
                            <!-- Defendants will be added here dynamically -->
                        </div>
                        <button type="button" class="btn btn-add" onclick="addDefendant()"><i class="fas fa-plus"></i> Add Defendant</button>
                    </div>
                </div>

                <!-- Submit Section -->
                <div class="section" id="section-submit">
                    <div class="section-content" style="text-align: center; padding: 20px;">
                        <button type="submit" class="btn" style="background: #00AEEF; font-size: 1.1rem; padding: 15px 40px;"><i class="fas fa-paper-plane"></i> Submit Form</button>
                    </div>
                </div>
                </form>
            </div>
        </div>

        <!-- Habitability Intake Form Tab Content -->
        <div id="habitability-tab" class="tab-content">
            <div class="form-content">
                <form id="habitability-form" class="form-main">

                    <!-- Section 1: Personal Information -->
                    <div class="section" id="section-personal-info">
                        <div class="section-header">
                            <h2 class="section-title">1. Personal Information</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="hab-first-name">First Name: <span class="required">*</span></label>
                                    <input type="text" id="hab-first-name" name="hab-first-name" placeholder="Enter first name" required>
                                </div>
                                <div class="form-group">
                                    <label for="hab-last-name">Last Name: <span class="required">*</span></label>
                                    <input type="text" id="hab-last-name" name="hab-last-name" placeholder="Enter last name" required>
                                </div>
                                <div class="form-group">
                                    <label for="hab-phone">Phone:</label>
                                    <input type="tel" id="hab-phone" name="hab-phone" placeholder="(555) 555-5555">
                                </div>
                                <div class="form-group">
                                    <label for="hab-email">Email: <span class="required">*</span></label>
                                    <input type="email" id="hab-email" name="hab-email" placeholder="email@example.com" required>
                                </div>
                                <div class="form-group">
                                    <label for="hab-eviction-case">Has an Unlawful Detainer (Eviction Case) Filed Against You?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-eviction-yes')">
                                            <input type="radio" id="hab-eviction-yes" name="hab-eviction-case" value="yes">
                                            <label for="hab-eviction-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-eviction-no')">
                                            <input type="radio" id="hab-eviction-no" name="hab-eviction-case" value="no">
                                            <label for="hab-eviction-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-how-found">How Did You Find Us?</label>
                                    <input type="text" id="hab-how-found" name="hab-how-found" placeholder="Referral, search, etc.">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Address -->
                    <div class="section" id="section-address">
                        <div class="section-header">
                            <h2 class="section-title">2. Address</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-grid">
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label for="hab-street-address">Street Address:</label>
                                    <input type="text" id="hab-street-address" name="hab-street-address" placeholder="Enter street address">
                                </div>
                                <div class="form-group">
                                    <label for="hab-city">City:</label>
                                    <input type="text" id="hab-city" name="hab-city" placeholder="Enter city">
                                </div>
                                <div class="form-group">
                                    <label for="hab-state">State:</label>
                                    <select id="hab-state" name="hab-state">
                                        <option value="">Select a state</option>
                                        <option value="AL">Alabama</option>
                                        <option value="AK">Alaska</option>
                                        <option value="AZ">Arizona</option>
                                        <option value="AR">Arkansas</option>
                                        <option value="CA">California</option>
                                        <option value="CO">Colorado</option>
                                        <option value="CT">Connecticut</option>
                                        <option value="DE">Delaware</option>
                                        <option value="FL">Florida</option>
                                        <option value="GA">Georgia</option>
                                        <option value="HI">Hawaii</option>
                                        <option value="ID">Idaho</option>
                                        <option value="IL">Illinois</option>
                                        <option value="IN">Indiana</option>
                                        <option value="IA">Iowa</option>
                                        <option value="KS">Kansas</option>
                                        <option value="KY">Kentucky</option>
                                        <option value="LA">Louisiana</option>
                                        <option value="ME">Maine</option>
                                        <option value="MD">Maryland</option>
                                        <option value="MA">Massachusetts</option>
                                        <option value="MI">Michigan</option>
                                        <option value="MN">Minnesota</option>
                                        <option value="MS">Mississippi</option>
                                        <option value="MO">Missouri</option>
                                        <option value="MT">Montana</option>
                                        <option value="NE">Nebraska</option>
                                        <option value="NV">Nevada</option>
                                        <option value="NH">New Hampshire</option>
                                        <option value="NJ">New Jersey</option>
                                        <option value="NM">New Mexico</option>
                                        <option value="NY">New York</option>
                                        <option value="NC">North Carolina</option>
                                        <option value="ND">North Dakota</option>
                                        <option value="OH">Ohio</option>
                                        <option value="OK">Oklahoma</option>
                                        <option value="OR">Oregon</option>
                                        <option value="PA">Pennsylvania</option>
                                        <option value="RI">Rhode Island</option>
                                        <option value="SC">South Carolina</option>
                                        <option value="SD">South Dakota</option>
                                        <option value="TN">Tennessee</option>
                                        <option value="TX">Texas</option>
                                        <option value="UT">Utah</option>
                                        <option value="VT">Vermont</option>
                                        <option value="VA">Virginia</option>
                                        <option value="WA">Washington</option>
                                        <option value="WV">West Virginia</option>
                                        <option value="WI">Wisconsin</option>
                                        <option value="WY">Wyoming</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="hab-postal-code">Postal Code:</label>
                                    <input type="text" id="hab-postal-code" name="hab-postal-code" placeholder="12345">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Client Details -->
                    <div class="section" id="section-client-details">
                        <div class="section-header">
                            <h2 class="section-title">3. Client Details</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="hab-unit-number">Unit # (Link to Client Card):</label>
                                    <input type="text" id="hab-unit-number" name="hab-unit-number" placeholder="Unit number">
                                </div>
                                <div class="form-group">
                                    <label for="hab-current-rent">Current Rent:</label>
                                    <input type="number" id="hab-current-rent" name="hab-current-rent" placeholder="0.00" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label for="hab-moved-in-date">Moved-In Date:</label>
                                    <input type="date" id="hab-moved-in-date" name="hab-moved-in-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-work">What Do You Do for Work?</label>
                                    <input type="text" id="hab-work" name="hab-work" placeholder="Your occupation">
                                </div>
                                <div class="form-group">
                                    <label for="hab-retainer">Have You Signed a Retainer with Another Attorney?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-retainer-yes')">
                                            <input type="radio" id="hab-retainer-yes" name="hab-retainer" value="yes">
                                            <label for="hab-retainer-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-retainer-no')">
                                            <input type="radio" id="hab-retainer-no" name="hab-retainer" value="no">
                                            <label for="hab-retainer-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-disabilities">Do You Have Any Disabilities?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-disabilities-yes')">
                                            <input type="radio" id="hab-disabilities-yes" name="hab-disabilities" value="yes">
                                            <label for="hab-disabilities-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-disabilities-no')">
                                            <input type="radio" id="hab-disabilities-no" name="hab-disabilities" value="no">
                                            <label for="hab-disabilities-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-spanish-speaking">Spanish Speaking?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-spanish-yes')">
                                            <input type="radio" id="hab-spanish-yes" name="hab-spanish-speaking" value="yes">
                                            <label for="hab-spanish-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-spanish-no')">
                                            <input type="radio" id="hab-spanish-no" name="hab-spanish-speaking" value="no">
                                            <label for="hab-spanish-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-veteran">Are You a Veteran?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-veteran-yes')">
                                            <input type="radio" id="hab-veteran-yes" name="hab-veteran" value="yes">
                                            <label for="hab-veteran-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-veteran-no')">
                                            <input type="radio" id="hab-veteran-no" name="hab-veteran" value="no">
                                            <label for="hab-veteran-no">No</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Household & Building Info -->
                    <div class="section" id="section-household-building">
                        <div class="section-header">
                            <h2 class="section-title">4. Household & Building Info</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="hab-units-in-building"># of Units in the Building:</label>
                                    <input type="number" id="hab-units-in-building" name="hab-units-in-building" placeholder="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="hab-children-in-unit"># of Children in Your Unit:</label>
                                    <input type="number" id="hab-children-in-unit" name="hab-children-in-unit" placeholder="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="hab-elderly-in-unit"># of Elderly in Your Unit:</label>
                                    <input type="number" id="hab-elderly-in-unit" name="hab-elderly-in-unit" placeholder="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="hab-number-of-people">Number of People:</label>
                                    <input type="number" id="hab-number-of-people" name="hab-number-of-people" placeholder="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="hab-income-under-45k">Is your approximate household income under $45,000?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-income-yes')">
                                            <input type="radio" id="hab-income-yes" name="hab-income-under-45k" value="yes">
                                            <label for="hab-income-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-income-no')">
                                            <input type="radio" id="hab-income-no" name="hab-income-under-45k" value="no">
                                            <label for="hab-income-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-management-company">Your Building Management Company or Manager's Name?</label>
                                    <input type="text" id="hab-management-company" name="hab-management-company" placeholder="Management company name">
                                </div>
                                <div class="form-group">
                                    <label for="hab-maintenance-man">Your Maintenance Man's Name?</label>
                                    <input type="text" id="hab-maintenance-man" name="hab-maintenance-man" placeholder="Maintenance person name">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Building Issues -->
                    <div class="section" id="section-building-issues">
                        <div class="section-header">
                            <h2 class="section-title">5. Building Issues</h2>
                        </div>
                        <div class="section-content">
                            
                            <!-- Electrical Issues -->
                            <div class="subsection">
                                <h3>Electrical</h3>
                                <div class="form-group">
                                    <label for="hab-electrical-issues">Do You Have Any Electrical Issues with the Building?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-electrical-yes')">
                                            <input type="radio" id="hab-electrical-yes" name="hab-electrical-issues" value="yes">
                                            <label for="hab-electrical-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-electrical-no')">
                                            <input type="radio" id="hab-electrical-no" name="hab-electrical-issues" value="no">
                                            <label for="hab-electrical-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-electrical-details">What electrical issues do you have with your unit? (e.g., wall switches not working, light fixtures, exterior lighting, electrical outlets, fans, smoke alarms)</label>
                                    <textarea id="hab-electrical-details" name="hab-electrical-details" rows="3" placeholder="Please describe electrical issues"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="hab-electrical-start-date">When Did Your Electrical Issues Start?</label>
                                    <input type="date" id="hab-electrical-start-date" name="hab-electrical-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-electrical-repairs">Were Any Electrical Repairs Made? (Include how long it took and how many times)</label>
                                    <textarea id="hab-electrical-repairs" name="hab-electrical-repairs" rows="3" placeholder="Please describe any repairs made"></textarea>
                                </div>
                            </div>

                            <!-- Appliances Issues -->
                            <div class="subsection">
                                <h3>Appliances</h3>
                                <div class="form-group">
                                    <label for="hab-appliance-problems">Do You Have Any Problems with the Appliances in Your Unit?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-appliance-yes')">
                                            <input type="radio" id="hab-appliance-yes" name="hab-appliance-problems" value="yes">
                                            <label for="hab-appliance-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-appliance-no')">
                                            <input type="radio" id="hab-appliance-no" name="hab-appliance-problems" value="no">
                                            <label for="hab-appliance-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-appliance-details">What issues do you have with your appliances? (e.g., stove, dishwasher, washer/dryer, trash compactor, garbage disposal)</label>
                                    <textarea id="hab-appliance-details" name="hab-appliance-details" rows="3" placeholder="Please describe appliance issues"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="hab-appliance-start-date">When Did Your Appliance Issues Start?</label>
                                    <input type="date" id="hab-appliance-start-date" name="hab-appliance-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-appliance-repairs">Were Any Appliance Repairs Made? (Include how long it took and how many times)</label>
                                    <textarea id="hab-appliance-repairs" name="hab-appliance-repairs" rows="3" placeholder="Please describe any repairs made"></textarea>
                                </div>
                            </div>

                            <!-- Heating / Air Conditioning Issues -->
                            <div class="subsection">
                                <h3>Heating / Air Conditioning</h3>
                                <div class="form-group">
                                    <label for="hab-heating-ac-problems">Do You Have Any Problems with the Heating / Air Conditioning in Your Unit?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-heating-yes')">
                                            <input type="radio" id="hab-heating-yes" name="hab-heating-ac-problems" value="yes">
                                            <label for="hab-heating-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-heating-no')">
                                            <input type="radio" id="hab-heating-no" name="hab-heating-ac-problems" value="no">
                                            <label for="hab-heating-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-heating-details">What issues do you have with your Heating / Air Conditioning? (e.g., heater, vents, AC unit, thermostat)</label>
                                    <textarea id="hab-heating-details" name="hab-heating-details" rows="3" placeholder="Please describe heating/AC issues"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="hab-heating-start-date">When Did Your Heating / Air Conditioning Issues Start?</label>
                                    <input type="date" id="hab-heating-start-date" name="hab-heating-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-heating-repairs">Were Any Heating / Air Conditioning Repairs Made? (Include how long it took and how many times)</label>
                                    <textarea id="hab-heating-repairs" name="hab-heating-repairs" rows="3" placeholder="Please describe any repairs made"></textarea>
                                </div>
                            </div>

                            <!-- Plumbing Issues -->
                            <div class="subsection">
                                <h3>Plumbing</h3>
                                <div class="form-group">
                                    <label for="hab-plumbing-problems">Do You Have Any Problems with Plumbing in Your Building?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-plumbing-yes')">
                                            <input type="radio" id="hab-plumbing-yes" name="hab-plumbing-problems" value="yes">
                                            <label for="hab-plumbing-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-plumbing-no')">
                                            <input type="radio" id="hab-plumbing-no" name="hab-plumbing-problems" value="no">
                                            <label for="hab-plumbing-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-plumbing-details">What plumbing issues do you have? (e.g., leaks, clogs, low pressure, sewage backups)</label>
                                    <textarea id="hab-plumbing-details" name="hab-plumbing-details" rows="3" placeholder="Please describe plumbing issues"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="hab-plumbing-start-date">When Did Your Plumbing Issues Start?</label>
                                    <input type="date" id="hab-plumbing-start-date" name="hab-plumbing-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-plumbing-repairs">Were Any Plumbing Repairs Made? (Include how long it took and how many times)</label>
                                    <textarea id="hab-plumbing-repairs" name="hab-plumbing-repairs" rows="3" placeholder="Please describe any repairs made"></textarea>
                                </div>
                            </div>

                            <!-- Flooring Issues -->
                            <div class="subsection">
                                <h3>Flooring</h3>
                                <div class="form-group">
                                    <label for="hab-flooring-issues">Do You Have Any Issues with the Flooring in Your Unit?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-flooring-yes')">
                                            <input type="radio" id="hab-flooring-yes" name="hab-flooring-issues" value="yes">
                                            <label for="hab-flooring-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-flooring-no')">
                                            <input type="radio" id="hab-flooring-no" name="hab-flooring-issues" value="no">
                                            <label for="hab-flooring-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-flooring-details">What flooring issues do you have? (e.g., cracked tiles, lifting laminate, water damage, holes)</label>
                                    <textarea id="hab-flooring-details" name="hab-flooring-details" rows="3" placeholder="Please describe flooring issues"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="hab-flooring-start-date">When Did Your Flooring Issues Start?</label>
                                    <input type="date" id="hab-flooring-start-date" name="hab-flooring-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-flooring-repairs">Were Any Flooring Repairs Made? (Include how long it took and how many times)</label>
                                    <textarea id="hab-flooring-repairs" name="hab-flooring-repairs" rows="3" placeholder="Please describe any repairs made"></textarea>
                                </div>
                            </div>

                            <!-- Windows Issues -->
                            <div class="subsection">
                                <h3>Windows</h3>
                                <div class="form-group">
                                    <label for="hab-windows-issues">Do You Have Any Issues with the Windows in Your Unit?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-windows-yes')">
                                            <input type="radio" id="hab-windows-yes" name="hab-windows-issues" value="yes">
                                            <label for="hab-windows-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-windows-no')">
                                            <input type="radio" id="hab-windows-no" name="hab-windows-issues" value="no">
                                            <label for="hab-windows-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-windows-details">What window issues do you have? (e.g., won't close, leaks, broken glass, mold around frames)</label>
                                    <textarea id="hab-windows-details" name="hab-windows-details" rows="3" placeholder="Please describe window issues"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="hab-windows-start-date">When Did Your Window Issues Start?</label>
                                    <input type="date" id="hab-windows-start-date" name="hab-windows-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-windows-repairs">Were Any Window Repairs Made? (Include how long it took and how many times)</label>
                                    <textarea id="hab-windows-repairs" name="hab-windows-repairs" rows="3" placeholder="Please describe any repairs made"></textarea>
                                </div>
                            </div>

                            <!-- Doors Issues -->
                            <div class="subsection">
                                <h3>Doors</h3>
                                <div class="form-group">
                                    <label for="hab-doors-issues">Do You Have Any Issues with the Doors in Your Unit?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-doors-yes')">
                                            <input type="radio" id="hab-doors-yes" name="hab-doors-issues" value="yes">
                                            <label for="hab-doors-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-doors-no')">
                                            <input type="radio" id="hab-doors-no" name="hab-doors-issues" value="no">
                                            <label for="hab-doors-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-doors-details">What door issues do you have? (e.g., broken locks, misaligned doors, gaps, weather stripping)</label>
                                    <textarea id="hab-doors-details" name="hab-doors-details" rows="3" placeholder="Please describe door issues"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="hab-doors-start-date">When Did Your Door Issues Start?</label>
                                    <input type="date" id="hab-doors-start-date" name="hab-doors-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-doors-repairs">Were Any Door Repairs Made? (Include how long it took and how many times)</label>
                                    <textarea id="hab-doors-repairs" name="hab-doors-repairs" rows="3" placeholder="Please describe any repairs made"></textarea>
                                </div>
                            </div>

                            <!-- Structure Issues -->
                            <div class="subsection">
                                <h3>Structure</h3>
                                <div class="form-group">
                                    <label for="hab-structure-problems">Do You Have Any Problems with the Structure of Your Unit?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-structure-yes')">
                                            <input type="radio" id="hab-structure-yes" name="hab-structure-problems" value="yes">
                                            <label for="hab-structure-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-structure-no')">
                                            <input type="radio" id="hab-structure-no" name="hab-structure-problems" value="no">
                                            <label for="hab-structure-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-structure-details">What structural issues do you have? (e.g., cracks, foundation problems, ceiling damage, leaning walls)</label>
                                    <textarea id="hab-structure-details" name="hab-structure-details" rows="3" placeholder="Please describe structural issues"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="hab-structure-start-date">When Did Your Structural Issues Start?</label>
                                    <input type="date" id="hab-structure-start-date" name="hab-structure-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-structure-repairs">Were Any Structural Repairs Made? (Include how long it took and how many times)</label>
                                    <textarea id="hab-structure-repairs" name="hab-structure-repairs" rows="3" placeholder="Please describe any repairs made"></textarea>
                                </div>
                            </div>

                            <!-- Nuisances -->
                            <div class="subsection">
                                <h3>Nuisances</h3>
                                <div class="form-group">
                                    <label for="hab-nuisances-problems">Do You Have Any Problems with the Nuisances of Your Unit?</label>
                                    <div class="radio-group inline">
                                        <div class="radio-item" onclick="selectRadio('hab-nuisances-yes')">
                                            <input type="radio" id="hab-nuisances-yes" name="hab-nuisances-problems" value="yes">
                                            <label for="hab-nuisances-yes">Yes</label>
                                        </div>
                                        <div class="radio-item" onclick="selectRadio('hab-nuisances-no')">
                                            <input type="radio" id="hab-nuisances-no" name="hab-nuisances-problems" value="no">
                                            <label for="hab-nuisances-no">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="hab-nuisances-details">What kind of nuisances effect Your Unit? (noisy neighbors drugs gangs criminal acts)</label>
                                    <textarea id="hab-nuisances-details" name="hab-nuisances-details" rows="3" placeholder="Please describe nuisance issues"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="hab-nuisances-start-date">When Did Your Issues with Nuisances Start?</label>
                                    <input type="date" id="hab-nuisances-start-date" name="hab-nuisances-start-date">
                                </div>
                                <div class="form-group">
                                    <label for="hab-nuisances-complaints">Did You File Any Complaints Due To Your Issues With Nuisances? Did they ever stop?</label>
                                    <textarea id="hab-nuisances-complaints" name="hab-nuisances-complaints" rows="3" placeholder="Please describe any complaints filed"></textarea>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Section 6: Common Area Issues -->
                    <div class="section" id="section-common-area-issues">
                        <div class="section-header">
                            <h2 class="section-title">6. Common Area Issues</h2>
                        </div>
                        <div class="section-content">
                            <div class="checkbox-grid">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-gym" value="gym">
                                    <span>Gym</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-mailbox" value="mailbox">
                                    <span>Mailbox</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-parking" value="parking">
                                    <span>Parking Area</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-security-gate" value="security-gate">
                                    <span>Broken security gate</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-flooding" value="flooding">
                                    <span>Flooding</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-recreation" value="recreation">
                                    <span>Recreation Room</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-plumbing-leaks" value="plumbing-leaks">
                                    <span>Plumbing leaks onto cars</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-inadequate-parking" value="inadequate-parking">
                                    <span>Inadequate space to park</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-entrance-blocked" value="entrance-blocked">
                                    <span>Entrance blocked</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-parking-not-enforced" value="parking-not-enforced">
                                    <span>Assigned parking not enforced</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-pool-jacuzzi" value="pool-jacuzzi">
                                    <span>Swimming Pool/jacuzzi: Does not work</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-elevator" value="elevator">
                                    <span>Elevator: Does not work</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-common-laundry" value="laundry">
                                    <span>Laundry room</span>
                                </label>
                            </div>
                            <div class="form-group" style="margin-top: 20px;">
                                <label for="hab-common-start-date">When Did Your Common Area Issues Start?</label>
                                <input type="date" id="hab-common-start-date" name="hab-common-start-date">
                            </div>
                            <div class="form-group">
                                <label for="hab-common-repairs">Were Any Common Area Repairs Made? (Include how long it took and how many times)</label>
                                <textarea id="hab-common-repairs" name="hab-common-repairs" rows="3" placeholder="Please describe any repairs made"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Section 7: Pest / Vermin Issues -->
                    <div class="section" id="section-pest-issues">
                        <div class="section-header">
                            <h2 class="section-title">7. Pest / Vermin Issues</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label for="hab-bugs-vermin">Do You Have Any Bugs or Vermin in Your Unit?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-bugs-yes')">
                                        <input type="radio" id="hab-bugs-yes" name="hab-bugs-vermin" value="yes">
                                        <label for="hab-bugs-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-bugs-no')">
                                        <input type="radio" id="hab-bugs-no" name="hab-bugs-vermin" value="no">
                                        <label for="hab-bugs-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="checkbox-grid" style="margin-top: 20px;">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-pest-ants" value="ants">
                                    <span>Ants</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-pest-cockroaches" value="cockroaches">
                                    <span>Cockroaches</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-pest-spiders" value="spiders">
                                    <span>Spiders</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-pest-bedbugs" value="bedbugs">
                                    <span>Bed bugs</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-pest-termites" value="termites">
                                    <span>Termites</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-pest-bees-wasps" value="bees-wasps">
                                    <span>Bees/wasps/hornets</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-pest-flies-mosquitos" value="flies-mosquitos">
                                    <span>Flies/mosquitos</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-pest-pigeons-bats" value="pigeons-bats">
                                    <span>Pigeons/bats</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-pest-mice-rats" value="mice-rats">
                                    <span>Mice/rats/rodents</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Section 8: Health & Safety Hazards -->
                    <div class="section" id="section-health-hazards">
                        <div class="section-header">
                            <h2 class="section-title">8. Health & Safety Hazards</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label for="hab-health-hazards">Do You Have Any Health Hazards in Your Unit?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-health-yes')">
                                        <input type="radio" id="hab-health-yes" name="hab-health-hazards" value="yes">
                                        <label for="hab-health-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-health-no')">
                                        <input type="radio" id="hab-health-no" name="hab-health-hazards" value="no">
                                        <label for="hab-health-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="checkbox-grid" style="margin-top: 20px;">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-hazard-mold" value="mold">
                                    <span>Mold / Mildew / Mushrooms</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-hazard-raw-sewage" value="raw-sewage">
                                    <span>Raw sewage on exterior ground</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-hazard-noxious-fumes-sewer" value="noxious-fumes-sewer">
                                    <span>Noxious fumes from sewer</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-hazard-other-toxic-fumes" value="other-toxic-fumes">
                                    <span>Other toxic/noxious fumes</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-hazard-smoke-neighbors" value="smoke-neighbors">
                                    <span>Smoke from neighbors in building</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-hazard-chemicals-paints" value="chemicals-paints">
                                    <span>Chemicals/paints contamination</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-hazard-offensive-senses" value="offensive-senses">
                                    <span>Hazards to health: Offensive to the senses</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-hazard-blocks-movement" value="blocks-movement">
                                    <span>Hazards to health: Blocks movement</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="hab-hazard-other" value="other">
                                    <span>Other</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Section 9: Landlord / Property Manager Conduct -->
                    <div class="section" id="section-landlord-conduct">
                        <div class="section-header">
                            <h2 class="section-title">9. Landlord / Property Manager Conduct</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label for="hab-harassed">Harassed by Landlord or Property Manager?</label>
                                <textarea id="hab-harassed" name="hab-harassed" rows="3" placeholder="Please describe any harassment"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="hab-rent-deductions">Received Rent Deductions due to Problems?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-rent-deductions-yes')">
                                        <input type="radio" id="hab-rent-deductions-yes" name="hab-rent-deductions" value="yes">
                                        <label for="hab-rent-deductions-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-rent-deductions-no')">
                                        <input type="radio" id="hab-rent-deductions-no" name="hab-rent-deductions" value="no">
                                        <label for="hab-rent-deductions-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="hab-relocated">Been Relocated due to Unit Issues?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-relocated-yes')">
                                        <input type="radio" id="hab-relocated-yes" name="hab-relocated" value="yes">
                                        <label for="hab-relocated-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-relocated-no')">
                                        <input type="radio" id="hab-relocated-no" name="hab-relocated" value="no">
                                        <label for="hab-relocated-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="hab-filed-housing-dept">Filed Anything with Housing Dept / Health Dept?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-filed-housing-yes')">
                                        <input type="radio" id="hab-filed-housing-yes" name="hab-filed-housing-dept" value="yes">
                                        <label for="hab-filed-housing-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-filed-housing-no')">
                                        <input type="radio" id="hab-filed-housing-no" name="hab-filed-housing-dept" value="no">
                                        <label for="hab-filed-housing-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="hab-lawsuit-involved">Filed or Been Involved in a Lawsuit?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-lawsuit-yes')">
                                        <input type="radio" id="hab-lawsuit-yes" name="hab-lawsuit-involved" value="yes">
                                        <label for="hab-lawsuit-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-lawsuit-no')">
                                        <input type="radio" id="hab-lawsuit-no" name="hab-lawsuit-involved" value="no">
                                        <label for="hab-lawsuit-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="hab-notices-received">Been Given Any Notices? What types?</label>
                                <input type="text" id="hab-notices-received" name="hab-notices-received" placeholder="e.g., 5-day, 10-day, etc.">
                            </div>
                            <div class="form-group">
                                <label for="hab-police-reports">Filed Any Police Reports?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-police-yes')">
                                        <input type="radio" id="hab-police-yes" name="hab-police-reports" value="yes">
                                        <label for="hab-police-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-police-no')">
                                        <input type="radio" id="hab-police-no" name="hab-police-reports" value="no">
                                        <label for="hab-police-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="hab-vandalism">Vandalism or Property Damage due to Theft or Leaks?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-vandalism-yes')">
                                        <input type="radio" id="hab-vandalism-yes" name="hab-vandalism" value="yes">
                                        <label for="hab-vandalism-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-vandalism-no')">
                                        <input type="radio" id="hab-vandalism-no" name="hab-vandalism" value="no">
                                        <label for="hab-vandalism-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="hab-unauthorized-entries">Unauthorized entries to your unit?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-unauthorized-yes')">
                                        <input type="radio" id="hab-unauthorized-yes" name="hab-unauthorized-entries" value="yes">
                                        <label for="hab-unauthorized-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-unauthorized-no')">
                                        <input type="radio" id="hab-unauthorized-no" name="hab-unauthorized-entries" value="no">
                                        <label for="hab-unauthorized-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="hab-additional-problems">Any Other or Additional Problems?</label>
                                <textarea id="hab-additional-problems" name="hab-additional-problems" rows="4" placeholder="Please describe any additional issues"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Section 10: Neighbors / Tenants -->
                    <div class="section" id="section-neighbors">
                        <div class="section-header">
                            <h2 class="section-title">10. Neighbors / Tenants</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label for="hab-neighbors-lawsuit">Any Neighbors Possibly Involved in the Same Lawsuit?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-neighbors-yes')">
                                        <input type="radio" id="hab-neighbors-yes" name="hab-neighbors-lawsuit" value="yes">
                                        <label for="hab-neighbors-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-neighbors-no')">
                                        <input type="radio" id="hab-neighbors-no" name="hab-neighbors-lawsuit" value="no">
                                        <label for="hab-neighbors-no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="hab-potential-case">Is This a Potential Case?</label>
                                <div class="radio-group inline">
                                    <div class="radio-item" onclick="selectRadio('hab-potential-yes')">
                                        <input type="radio" id="hab-potential-yes" name="hab-potential-case" value="yes">
                                        <label for="hab-potential-yes">Yes</label>
                                    </div>
                                    <div class="radio-item" onclick="selectRadio('hab-potential-no')">
                                        <input type="radio" id="hab-potential-no" name="hab-potential-case" value="no">
                                        <label for="hab-potential-no">No</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 11: Documents Needed -->
                    <div class="section" id="section-documents">
                        <div class="section-header">
                            <h2 class="section-title">11. Documents Needed (Reminder)</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label for="hab-lease">Lease:</label>
                                <input type="file" id="hab-lease" name="hab-lease" accept=".pdf,.doc,.docx,.jpg,.png">
                            </div>
                            <div class="form-group">
                                <label for="hab-photos-videos">Photos or Videos of Any Habitability Issues:</label>
                                <input type="file" id="hab-photos-videos" name="hab-photos-videos" accept=".jpg,.png,.mp4,.mov" multiple>
                            </div>
                            <div class="form-group">
                                <label for="hab-deductions">Copies of Any Deductions or Offsets:</label>
                                <input type="file" id="hab-deductions" name="hab-deductions" accept=".pdf,.doc,.docx,.jpg,.png" multiple>
                            </div>
                            <div class="form-group">
                                <label for="hab-prior-contact">Copies of Prior Contact with Landlord / Owner:</label>
                                <input type="file" id="hab-prior-contact" name="hab-prior-contact" accept=".pdf,.doc,.docx,.jpg,.png,.eml" multiple>
                            </div>
                            <div class="form-group">
                                <label for="hab-additional-notes">Any Additional Notes:</label>
                                <textarea id="hab-additional-notes" name="hab-additional-notes" rows="4" placeholder="Any other relevant information"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Section 12: Submission -->
                    <div class="section" id="section-submission-hab">
                        <div class="section-header">
                            <h2 class="section-title">12. Submission</h2>
                        </div>
                        <div class="section-content">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="hab-submitted-by">Submitted By:</label>
                                    <input type="text" id="hab-submitted-by" name="hab-submitted-by" placeholder="Your name">
                                </div>
                                <div class="form-group">
                                    <label for="hab-cases">Cases: <span class="required">*</span></label>
                                    <select id="hab-cases" name="hab-cases" required>
                                        <option value="">Select a case</option>
                                        <option value="case1">Case 1</option>
                                        <option value="case2">Case 2</option>
                                        <option value="case3">Case 3</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Submit Habitability Form
                        </button>
                    </div>

                </form>
            </div>
        </div>

        <!-- Submissions Tab Content -->
        <div id="submissions-tab" class="tab-content">
            <div class="submissions-content">
                <div class="submissions-header">
                    <h2><i class="fas fa-database"></i> Form Submissions</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-refresh" onclick="loadSubmissions()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn" onclick="clearAllSubmissions()" style="background: #DC3545;">
                            <i class="fas fa-trash-alt"></i> Clear All
                        </button>
                    </div>
                </div>

                <div class="submissions-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-submissions">-</div>
                        <div class="stat-label">Total Submissions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="submissions-today">-</div>
                        <div class="stat-label">Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="submissions-this-week">-</div>
                        <div class="stat-label">This Week</div>
                    </div>
                </div>

                <div class="submissions-controls">
                    <div class="search-box">
                        <input type="text" id="search-submissions" placeholder="Search submissions..." onkeyup="filterSubmissions()">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="sort-controls">
                        <select id="sort-submissions" onchange="sortSubmissions()">
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="name-asc">Name A-Z</option>
                            <option value="name-desc">Name Z-A</option>
                        </select>
                    </div>
                </div>

                <div id="submissions-loading" class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Loading submissions...
                </div>

                <div id="submissions-error" class="error-message" style="display: none;">
                    Failed to load submissions. Please try refreshing.
                </div>

                <div id="submissions-list" class="submissions-list">
                    <!-- Submissions will be loaded here -->
                </div>

                <div id="no-submissions" class="no-submissions" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No Submissions Found</h3>
                    <p>No form submissions have been created yet. Use the "Create Form" tab to submit your first entry.</p>
                </div>
            </div>
        </div>
    </div>
    <aside class="summary-panel" aria-labelledby="summary-title">
        <h3 id="summary-title"><i class="fa-solid fa-briefcase" aria-hidden="true"></i> At a Glance</h3>
        <p>Key details update as you complete the form.</p>
        <div class="summary-grid">
            <div class="summary-card">
                <h4>Case</h4>
                <div class="summary-value" id="summary-property-address">Add property address</div>
                <div class="summary-subvalue" id="summary-property-location">City, State</div>
                <div class="summary-subvalue" id="summary-filing-city"><strong>Filing City:</strong> —</div>
                <div class="summary-subvalue" id="summary-filing-county"><strong>Filing County:</strong> —</div>
            </div>
            <div class="summary-card">
                <h4>Parties</h4>
                <div class="summary-list">
                    <span class="summary-list-title">Plaintiffs (<span id="summary-plaintiff-count">0</span>)</span>
                    <ul class="summary-list-items" id="summary-plaintiff-list">
                        <li class="summary-empty">Add first plaintiff</li>
                    </ul>
                </div>
                <div class="summary-list">
                    <span class="summary-list-title">Defendants (<span id="summary-defendant-count">0</span>)</span>
                    <ul class="summary-list-items" id="summary-defendant-list">
                        <li class="summary-empty">Add first defendant</li>
                    </ul>
                </div>
            </div>
        </div>
        <p class="summary-footnote hidden" id="summary-footnote">*</p>
    </aside>
</div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content confirmation-modal">
            <div class="modal-header">
                <i class="fas fa-clipboard-check" style="color: #00AEEF; font-size: 2rem; margin-bottom: 10px;"></i>
                <h2>Ready to Submit?</h2>
                <p style="margin: 8px 0 0 0; font-size: 0.95rem; opacity: 0.9; font-weight: normal;">Please confirm that you have reviewed all information before submitting.</p>
            </div>
            <div class="modal-body">
                <div class="confirmation-checklist">
                    <div class="checklist-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Property information is entered correctly</span>
                    </div>
                    <div class="checklist-item">
                        <i class="fas fa-check-circle"></i>
                        <span>All plaintiffs have been added</span>
                    </div>
                    <div class="checklist-item">
                        <i class="fas fa-check-circle"></i>
                        <span>All defendants have been added</span>
                    </div>
                    <div class="checklist-item">
                        <i class="fas fa-check-circle"></i>
                        <span>All applicable issues have been selected</span>
                    </div>
                </div>
                <div class="confirmation-note">
                    <i class="fas fa-info-circle"></i>
                    <span>You can return to the form to make changes by clicking "Go Back".</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmationModal()">
                    <i class="fas fa-arrow-left"></i> Go Back
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmSubmission()">
                    <i class="fas fa-paper-plane"></i> Confirm & Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Email Notification Modal -->
    <div id="emailNotificationModal" class="modal">
        <div class="modal-content confirmation-modal">
            <div class="modal-header">
                <i class="fas fa-envelope-open-text" style="color: #00AEEF; font-size: 2rem; margin-bottom: 10px;"></i>
                <h2>Email Notifications?</h2>
                <p style="margin: 8px 0 0 0; font-size: 0.95rem; opacity: 0.9; font-weight: normal;">Would you like to receive an email when your documents are processed?</p>
            </div>
            <div class="modal-body">
                <div class="confirmation-note" style="margin-bottom: 20px;">
                    <i class="fas fa-info-circle"></i>
                    <span>This is optional. Enter an email address to get a notification when processing is complete.</span>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="notificationEmailInput">Email address</label>
                    <input type="email" id="notificationEmailInput" name="notificationEmailInput" placeholder="Email notification functionality coming soon..." disabled>
                </div>
                <p id="notificationEmailError" class="modal-error" style="display: none;">Please enter a valid email address or skip this step.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="skipEmailNotification()">
                    <i class="fas fa-times"></i> Skip & Submit
                </button>
                <button type="button" class="btn btn-primary" onclick="submitEmailNotification()">
                    <i class="fas fa-paper-plane"></i> Save Email & Submit
                </button>
            </div>
        </div>
    </div>

    <script>
        // Get access token from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const ACCESS_TOKEN = urlParams.get('token');

        // Helper function to make authenticated API requests
        async function authenticatedFetch(url, options = {}) {
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${ACCESS_TOKEN}`
            };
            return fetch(url, { ...options, headers });
        }

        /**
         * Legal Form Dynamic Content Management System
         *
         * This comprehensive script manages all dynamic form functionality including:
         * - Dynamic addition and removal of plaintiff and defendant sections
         * - Conditional display of household information based on user selections
         * - Enhanced checkbox/radio button interactions with large clickable areas
         * - Issue category management with expandable sections
         * - Form submission with custom styled confirmation modal
         * - Inline validation with live error/success feedback
         * - User experience enhancements for better accessibility
         * - Pipeline status tracking with toast notifications (Phase 5)
         *
         * Key Features:
         * - Enhanced UX: Large clickable areas for all interactive elements
         * - Category Management: Expandable issue categories with comprehensive tracking
         * - Custom Confirmation Modal: Styled modal dialog to confirm submission before processing
         * - Direct Submission: Form data submitted directly to backend API
         * - Pipeline Status: Real-time progress tracking for document generation
         * - Accessibility: Improved interaction patterns for better usability
         *
         * Updated: 2025-10-18 - Added Phase 5 pipeline status toast with polling
         * Updated: 2025-10-07 - Replaced complex review screen with custom confirmation modal
         */

        // Removed pipeline toast manager and polling logic

        // ============================================
        // FORM MANAGEMENT (Existing Code)
        // ============================================

        // Global counters for unique IDs
        // Exposed as window properties for external access (e.g., form-submission.js)
        window.plaintiffCounter = 0;
        window.defendantCounter = 0;

        const stepperState = {
            observer: null,
            sections: [],
            initialized: false
        };

        const stepperObserverOptions = {
            rootMargin: '-45% 0px -45% 0px',
            threshold: [0.2, 0.4, 0.6]
        };

        let stepperVisible = true;

        /**
         * Set the expanded state for a repeatable section and sync ARIA attributes.
         * @param {HTMLElement} section - The section element to update.
         * @param {boolean} expanded - Whether the section should be expanded.
         */
        /**
         * Update plaintiff section title based on name fields
         * @param {number} plaintiffId - The ID number of the plaintiff section
         */
        function updatePlaintiffTitle(plaintiffId) {
            const section = document.getElementById(`plaintiff-${plaintiffId}`);
            if (!section) return;

            const firstName = section.querySelector(`[name="plaintiff-${plaintiffId}-first-name"]`)?.value || '';
            const lastName = section.querySelector(`[name="plaintiff-${plaintiffId}-last-name"]`)?.value || '';
            const titleSpan = section.querySelector('.repeatable-title');
            
            if (!titleSpan) return;

            if (firstName && lastName) {
                titleSpan.textContent = `${firstName} ${lastName}`;
            } else if (firstName) {
                titleSpan.textContent = firstName;
            } else {
                titleSpan.textContent = `Plaintiff #${plaintiffId}`;
            }
        }

        function setRepeatableExpansion(section, expanded) {
            if (!section) {
                return;
            }
            const button = section.querySelector('.repeatable-toggle');
            const content = section.querySelector('.repeatable-content');
            if (!button || !content) {
                return;
            }
            button.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            section.classList.toggle('is-collapsed', !expanded);
            content.toggleAttribute('hidden', !expanded);
        }

        /**
         * Toggle a repeatable section by ID, optionally forcing an expanded state.
         * For plaintiff sections, updates the section title with name information when collapsing.
         * 
         * @param {string} sectionId - The ID of the section element.
         * @param {boolean} [forceState] - Optional desired state.
         * 
         * Behavior:
         * - When expanding: Shows standard section content
         * - When collapsing a plaintiff section: 
         *   * Updates title to show full name if available
         *   * Falls back to first name only if last name is empty
         *   * Uses default "Plaintiff #X" if no name is provided
         */
        function toggleRepeatableSection(sectionId, forceState) {
            const section = document.getElementById(sectionId);
            if (!section) {
                return;
            }
            const button = section.querySelector('.repeatable-toggle');
            if (!button) {
                return;
            }
            const expanded = typeof forceState === 'boolean'
                ? forceState
                : button.getAttribute('aria-expanded') !== 'true';
            
            // Update title when collapsing sections
            if (!expanded) {
                if (section.id.startsWith('plaintiff-')) {
                    const plaintiffId = section.id.split('-')[1];
                    updatePlaintiffTitle(plaintiffId);
                } else if (section.id.startsWith('defendant-')) {
                    const defendantId = section.id.split('-')[1];
                    updateDefendantTitle(defendantId);
                }
            }
            
            setRepeatableExpansion(section, expanded);
            refreshCollapseToggleForSection(section);
        }

        /**
         * Ensure a repeatable section is initialized with listeners and default state.
         * @param {HTMLElement} section - The section to initialize.
         */
        function initializeRepeatableSection(section) {
            if (!section || section.dataset.repeatableReady === 'true') {
                return;
            }
            const button = section.querySelector('.repeatable-toggle');
            if (button) {
                button.addEventListener('click', () => toggleRepeatableSection(section.id));
            }
            setRepeatableExpansion(section, true);
            section.dataset.repeatableReady = 'true';
            refreshCollapseToggleForSection(section);
        }

        /**
         * Initialize all repeatable sections within a root element.
         * @param {ParentNode} [root=document] - The root node to search within.
         */
        function initializeRepeatableSections(root = document) {
            const sections = root.querySelectorAll('.repeatable-section');
            sections.forEach(section => initializeRepeatableSection(section));
        }

        /**
         * Update the state of a collapse-all control based on its container sections.
         * @param {string} containerId - The ID of the container holding repeatable sections.
         */
        function refreshCollapseToggle(containerId) {
            const container = document.getElementById(containerId);
            const control = document.querySelector(`.repeatable-collapse-toggle[data-target="${containerId}"]`);
            if (!container || !control) {
                return;
            }
            const sections = container.querySelectorAll('.repeatable-section');
            if (!sections.length) {
                control.disabled = true;
                control.textContent = 'Collapse All';
                control.dataset.state = 'collapsed';
                control.setAttribute('aria-pressed', 'false');
                return;
            }
            control.disabled = false;
            const expandedSections = Array.from(sections).filter(section => {
                const button = section.querySelector('.repeatable-toggle');
                return button && button.getAttribute('aria-expanded') === 'true';
            });
            const allExpanded = expandedSections.length === sections.length;
            const noneExpanded = expandedSections.length === 0;
            if (allExpanded) {
                control.textContent = 'Collapse All';
                control.dataset.state = 'expanded';
                control.setAttribute('aria-pressed', 'true');
            } else if (noneExpanded) {
                control.textContent = 'Expand All';
                control.dataset.state = 'collapsed';
                control.setAttribute('aria-pressed', 'false');
            } else {
                control.textContent = 'Collapse All';
                control.dataset.state = 'mixed';
                control.setAttribute('aria-pressed', 'mixed');
            }
        }

        /**
         * Update collapse-all control when a specific section changes.
         * @param {HTMLElement} section - The section whose parent container should be refreshed.
         */
        function refreshCollapseToggleForSection(section) {
            if (!section) {
                return;
            }
            let container = section.parentElement;
            while (container && !container.id) {
                container = container.parentElement;
            }
            if (container && container.id) {
                refreshCollapseToggle(container.id);
            }
        }

        /**
         * Toggle all repeatable sections within a container.
         * @param {string} containerId - The ID of the container holding repeatable sections.
         * @param {HTMLButtonElement} control - The "collapse all" control button.
         */
        function toggleAllRepeatables(containerId, control) {
            const container = document.getElementById(containerId);
            if (!container) {
                return;
            }
            const sections = container.querySelectorAll('.repeatable-section');
            if (!sections.length) {
                refreshCollapseToggle(containerId);
                return;
            }
            const state = control ? control.dataset.state : 'expanded';
            const expand = state === 'collapsed';
            sections.forEach(section => setRepeatableExpansion(section, expand));
            refreshCollapseToggle(containerId);
        }

        /**
         * Highlight the currently active step in the sidebar.
         * @param {string} activeId
         */
        function setActiveStepperLink(activeId) {
            if (!stepperState.sections.length) return;
            stepperState.sections.forEach(({ link, section }) => {
                const isActive = section.id === activeId;
                link.classList.toggle('active', isActive);
                if (isActive) {
                    link.setAttribute('aria-current', 'step');
                } else {
                    link.removeAttribute('aria-current');
                }
            });
        }

        /**
         * Handle intersection events to update active step as user scrolls.
         * @param {IntersectionObserverEntry[]} entries
         */
        function handleStepperIntersection(entries) {
            if (!entries || !entries.length) return;
            const visible = entries.filter(entry => entry.isIntersecting);
            if (visible.length) {
                visible.sort((a, b) => {
                    const indexA = stepperState.sections.findIndex(item => item.section === a.target);
                    const indexB = stepperState.sections.findIndex(item => item.section === b.target);
                    return indexA - indexB;
                });
                setActiveStepperLink(visible[0].target.id);
                return;
            }
            const nearest = entries.slice().sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top)[0];
            if (nearest) {
                setActiveStepperLink(nearest.target.id);
            }
        }

        /**
         * Activate the intersection observer used to highlight the current step.
         */
        function activateStepperObserver() {
            if (!stepperVisible || !stepperState.sections.length) return;
            if (stepperState.observer) {
                stepperState.observer.disconnect();
            }
            stepperState.observer = new IntersectionObserver(handleStepperIntersection, stepperObserverOptions);
            stepperState.sections.forEach(({ section }) => stepperState.observer.observe(section));
            setActiveStepperLink(stepperState.sections[0].section.id);
        }

        /**
         * Initialize the sticky stepper navigation.
         */
        function initializeStepper() {
            const links = Array.from(document.querySelectorAll('.stepper-link'));
            if (!links.length) return;

            const sections = links.map(link => {
                const targetId = link.getAttribute('href');
                if (!targetId || !targetId.startsWith('#')) return null;
                const section = document.querySelector(targetId);
                if (!section) return null;
                return { link, section };
            }).filter(Boolean);

            if (!sections.length) return;

            stepperState.sections = sections;
            stepperState.initialized = true;

            links.forEach(link => {
                if (link.dataset.stepperInit === 'true') return;
                link.addEventListener('click', event => {
                    event.preventDefault();
                    const targetId = link.getAttribute('href');
                    const target = document.querySelector(targetId);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        setActiveStepperLink(target.id);
                    }
                }, { passive: false });
                link.dataset.stepperInit = 'true';
            });

            activateStepperObserver();
        }

        /**
         * Show or hide the stepper navigation and manage related UI state.
         * @param {boolean} visible
         * @param {{focus?: boolean}} [options]
         */
        function setStepperVisibility(visible, options = {}) {
            const { focus = true } = options;
            stepperVisible = visible;

            const stepper = document.getElementById('progress-sidebar');
            const showButton = document.getElementById('show-stepper-button');
            const layout = document.querySelector('.page-layout');

            if (stepper) {
            stepper.classList.toggle('stepper-collapsed', !visible);
            stepper.classList.remove('hidden');
            stepper.setAttribute('aria-hidden', visible ? 'false' : 'false');
        }

        if (showButton) {
            showButton.classList.toggle('hidden', visible);
            showButton.setAttribute('aria-hidden', visible ? 'true' : 'false');
            }

            if (layout) {
            layout.classList.remove('stepper-hidden');
            }

            if (visible) {
                activateStepperObserver();
                if (focus) {
                    const hideButton = document.getElementById('hide-stepper-button');
                    if (hideButton && typeof hideButton.focus === 'function') {
                        hideButton.focus();
                    }
                }
            } else {
                if (stepperState.observer) {
                    stepperState.observer.disconnect();
                }
                if (focus) {
                    const showBtn = document.getElementById('show-stepper-button');
                    if (showBtn && !showBtn.classList.contains('hidden') && typeof showBtn.focus === 'function') {
                        showBtn.focus();
                    }
                }
            }
        }

        /**
         * Apply stepper visibility rules depending on the active tab.
         * @param {boolean} isFormTab
         */
        function applyStepperForTab(isFormTab) {
            const stepper = document.getElementById('progress-sidebar');
            const showButton = document.getElementById('show-stepper-button');
            const layout = document.querySelector('.page-layout');

            if (isFormTab) {
            if (stepperState.initialized) {
                if (stepper) {
                    stepper.classList.remove('hidden');
                    stepper.setAttribute('aria-hidden', 'false');
                }
                setStepperVisibility(stepperVisible, { focus: false });
            }
            if (layout) {
                layout.classList.remove('stepper-hidden');
            }
                return;
            }

            if (stepper) {
                stepper.classList.add('hidden');
                stepper.classList.remove('stepper-collapsed');
                stepper.setAttribute('aria-hidden', 'true');
            }
            if (showButton) {
                showButton.classList.add('hidden');
                showButton.setAttribute('aria-hidden', 'true');
            }
            if (layout) {
                layout.classList.add('stepper-hidden');
            }
            if (stepperState.observer) {
                stepperState.observer.disconnect();
            }
        }

        /**
         * Create or return the validation message element within a form-group.
         * @param {HTMLElement} group
         * @returns {HTMLElement}
         */
        function ensureValidationMessage(group) {
            let message = group.querySelector('.validation-message');
            if (!message) {
                message = document.createElement('div');
                message.className = 'validation-message';
                message.setAttribute('role', 'status');
                message.style.display = 'none';
                group.appendChild(message);
            }
            return message;
        }

        /**
         * Remove validation styles and messages from a form field.
         * @param {HTMLInputElement|HTMLSelectElement|HTMLTextAreaElement} field
         */
        function clearValidationState(field) {
            const group = field.closest('.form-group');
            if (!group) return;
            group.classList.remove('has-error', 'has-success');
            const message = group.querySelector('.validation-message');
            if (message) {
                message.textContent = '';
                message.style.display = 'none';
            }
        }

        /**
         * Extract a clean label for the provided form group.
         * @param {HTMLElement} group
         * @returns {string}
         */
        function getGroupLabelText(group) {
            if (!group) return 'This field';
            if (group.dataset.labelText) {
                return group.dataset.labelText;
            }
            const label = group.querySelector('label');
            if (!label) return 'This field';
            const clone = label.cloneNode(true);
            clone.querySelectorAll('.required-marker').forEach(el => el.remove());
            const text = clone.textContent.replace(/[:*?]|\s+$/g, '').trim().replace(/\s+/g, ' ');
            const fallback = text || 'This field';
            group.dataset.labelText = fallback;
            return fallback;
        }

        /**
         * Validate a form field and render inline messaging.
         * @param {HTMLInputElement|HTMLSelectElement|HTMLTextAreaElement} field
         * @param {Object} [options]
         * @param {boolean} [options.force=false] - When true, always show feedback even if untouched.
         * @returns {boolean}
         */
        function validateInteractiveField(field, options = {}) {
            if (!field || field.disabled) return true;

            // Prevent recursive validation loops
            if (field.dataset.validating === 'true') return true;

            const group = field.closest('.form-group');
            if (!group) return true;

            const requireFeedback = field.required || group.classList.contains('required');
            const messageEl = ensureValidationMessage(group);
            const labelText = getGroupLabelText(group);
            const trimmedValue = field.value != null ? field.value.trim() : '';
            const isRadio = field.type === 'radio';
            const isCheckbox = field.type === 'checkbox';
            const isVisible = field.offsetParent !== null && group.closest('.hidden') === null;

            if (!isVisible) {
                clearValidationState(field);
                return true;
            }

            let isValid = true;
            let message = '';

            if (isRadio) {
                if (!requireFeedback) {
                    clearValidationState(field);
                    return true;
                }
                const radios = document.querySelectorAll(`input[type="radio"][name="${field.name.replace(/"/g, '\\"')}"]`);
                isValid = Array.from(radios).some(radio => radio.checked);
                if (!isValid) {
                    message = `Select an option for ${labelText.toLowerCase()}.`;
                }
            } else if (isCheckbox) {
                if (!requireFeedback) {
                    clearValidationState(field);
                    return true;
                }
                if (!field.checked) {
                    isValid = false;
                    message = `Check the box for ${labelText.toLowerCase()}.`;
                }
            } else {
                if (requireFeedback || trimmedValue !== '') {
                    // Set flag to prevent recursive validation
                    field.dataset.validating = 'true';
                    try {
                        isValid = field.checkValidity();
                        if (!isValid) {
                            if (field.validity.valueMissing) {
                                message = `${labelText} is required.`;
                            } else if (field.validity.patternMismatch && field.dataset.patternMessage) {
                                message = field.dataset.patternMessage;
                            } else {
                                message = field.validationMessage || `${labelText} is invalid.`;
                            }
                        }
                    } finally {
                        // Always clear the flag
                        delete field.dataset.validating;
                    }
                }

                if (requireFeedback && trimmedValue === '') {
                    isValid = false;
                    message = `${labelText} is required.`;
                }
            }

            if (!options.force && field.dataset.touched !== 'true' && trimmedValue === '') {
                clearValidationState(field);
                return isValid;
            }

            group.classList.remove('has-error', 'has-success');
            if (!isValid) {
                group.classList.add('has-error');
                messageEl.textContent = message || `${labelText} needs attention.`;
                messageEl.style.display = 'block';
            } else if (requireFeedback && trimmedValue !== '') {
                group.classList.add('has-success');
                messageEl.textContent = 'Looks good.';
                messageEl.style.display = 'block';
            } else {
                clearValidationState(field);
            }

            return isValid;
        }

        /**
         * Attach validation listeners to fields within the provided root element.
         * @param {ParentNode} root
         */
        function initializeValidation(root = document) {
            if (!root) return;
            const groups = root.querySelectorAll('.form-group');
            groups.forEach(group => {
                const fields = group.querySelectorAll('input, select, textarea');
                const hasRequired = Array.from(fields).some(field => field.required);
                if (hasRequired) {
                    group.classList.add('required');
                    const label = group.querySelector('label');
                    if (label && !label.querySelector('.required-marker')) {
                        const marker = document.createElement('span');
                        marker.className = 'required-marker';
                        marker.setAttribute('aria-hidden', 'true');
                        marker.textContent = '*';
                        label.appendChild(marker);
                    }
                }

                fields.forEach(field => {
                    if (['button', 'submit', 'reset', 'hidden'].includes(field.type)) {
                        return;
                    }
                    if (field.dataset.validationBound === 'true') {
                        return;
                    }
                    field.dataset.validationBound = 'true';

                    field.addEventListener('focus', () => {
                        field.dataset.touched = 'true';
                    });

                    field.addEventListener('blur', () => {
                        field.dataset.touched = 'true';
                        validateInteractiveField(field, { force: true });
                    });

                    const handler = () => {
                        if (field.dataset.touched === 'true') {
                            validateInteractiveField(field, { force: true });
                        } else if (field.value === '') {
                            clearValidationState(field);
                        }
                    };

                    field.addEventListener('input', handler);
                    field.addEventListener('change', handler);

                    field.addEventListener('invalid', (event) => {
                        event.preventDefault();
                        field.dataset.touched = 'true';
                        validateInteractiveField(field, { force: true });
                    });
                });
            });
        }

        /**
         * Validate all visible fields prior to submission.
         * @param {HTMLFormElement} form
         * @returns {boolean}
         */
        function runFullValidation(form) {
            if (!form) return false;
            initializeValidation(form);

            const fields = form.querySelectorAll('input, select, textarea');
            let isFormValid = true;
            let firstInvalid = null;

            fields.forEach(field => {
                if (field.disabled) return;
                if (['button', 'submit', 'reset', 'hidden'].includes(field.type)) return;
                if (field.closest('.hidden')) return;

                field.dataset.touched = 'true';
                const isValid = validateInteractiveField(field, { force: true });
                if (!isValid) {
                    isFormValid = false;
                    if (!firstInvalid) {
                        firstInvalid = field;
                    }
                }
            });

            if (!isFormValid && firstInvalid) {
                firstInvalid.focus({ preventScroll: false });
            }

            return isFormValid;
        }

        /**
         * Escape basic HTML characters to prevent injection.
         * @param {string} value - Raw string input from the form.
         * @returns {string} Escaped string safe for innerHTML.
         */
        function escapeHtml(value) {
            if (!value) {
                return '';
            }
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                '\'': '&#39;'
            };
            return value.replace(/[&<>"']/g, char => map[char]);
        }

        /**
         * Convert a string to Title Case (first letter uppercase, rest lowercase).
         * @param {string} value - Input string.
         * @returns {string} Title cased string.
         */
        function toTitleCase(value) {
            if (!value) {
                return '';
            }
            return value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
        }

        /**
         * Format a person's name by combining first and last name inputs.
         * @param {HTMLElement} section - The DOM node containing the inputs.
         * @returns {string} The formatted name or an empty string.
         */
        function extractNameFromSection(section) {
            if (!section) {
                return '';
            }
            const first = section.querySelector('input[name$="-first-name"]');
            const last = section.querySelector('input[name$="-last-name"]');
            const firstValue = first ? first.value.trim() : '';
            const lastValue = last ? last.value.trim() : '';
            const combined = `${firstValue} ${lastValue}`.trim();
            return combined.replace(/\s+/g, ' ');
        }

        /**
         * Update the At a Glance summary panel with the latest form values.
         * 
         * This function refreshes various elements in the summary panel to reflect
         * current form state including:
         * - Filing location (city and county) with bold labels
         * - Dynamic party counts in section headers (e.g., "Plaintiffs (3)")
         * - Plaintiff list with types and household indicators
         * - Defendant list with entity types and roles
         * 
         * The function maintains a clean, hierarchical display by:
         * - Using bold styling for filing metadata labels
         * - Showing party counts directly in section headers
         * - Updating counts automatically when parties are added/removed
         */
        function updateSummaryPanel() {
            const addressDisplay = document.getElementById('summary-property-address');
            if (!addressDisplay) {
                return;
            }

            const appendIfValue = (value, label) => (value ? `${label}${value}` : '');

            const address = document.getElementById('property-address');
            const unit = document.getElementById('apartment-unit');
            const addressText = address && address.value.trim()
                ? `${address.value.trim()}${unit && unit.value.trim() ? appendIfValue(unit.value.trim(), ', Unit ') : ''}`
                : 'Add property address';
            addressDisplay.textContent = addressText;

            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const zipInput = document.getElementById('zip-code');
            const city = cityInput ? cityInput.value.trim() : '';
            const state = stateInput ? stateInput.value.trim() : '';
            const zip = zipInput ? zipInput.value.trim() : '';
            const locationDisplay = document.getElementById('summary-property-location');
            if (locationDisplay) {
                const parts = [];
                if (city) parts.push(city);
                if (state) parts.push(state);
                if (zip) parts.push(zip);
                locationDisplay.textContent = parts.length > 0 ? parts.join(', ') : 'City, State';
            }

            const plaintiffs = Array.from(document.querySelectorAll('#plaintiffs-container .repeatable-section'));
            const defendants = Array.from(document.querySelectorAll('#defendants-container .repeatable-section'));

            const filingCityInput = document.getElementById('filing-city');
            const filingCountyInput = document.getElementById('filing-county');
            const filingCity = filingCityInput ? filingCityInput.value.trim() : '';
            const filingCounty = filingCountyInput ? filingCountyInput.value.trim() : '';
            const filingCityDisplay = document.getElementById('summary-filing-city');
            if (filingCityDisplay) {
                filingCityDisplay.innerHTML = filingCity ? `<strong>Filing City:</strong> ${filingCity}` : '<strong>Filing City:</strong> —';
            }

            const filingCountyDisplay = document.getElementById('summary-filing-county');
            if (filingCountyDisplay) {
                filingCountyDisplay.innerHTML = filingCounty ? `<strong>Filing County:</strong> ${filingCounty}` : '<strong>Filing County:</strong> —';
            }

            // Update plaintiff and defendant counts
            const plaintiffCountDisplay = document.getElementById('summary-plaintiff-count');
            if (plaintiffCountDisplay) {
                plaintiffCountDisplay.textContent = plaintiffs.length;
            }

            const defendantCountDisplay = document.getElementById('summary-defendant-count');
            if (defendantCountDisplay) {
                defendantCountDisplay.textContent = defendants.length;
            }

            const plaintiffList = document.getElementById('summary-plaintiff-list');
            if (plaintiffList) {
                if (plaintiffs.length === 0) {
                    plaintiffList.innerHTML = '<li class="summary-empty">Add first plaintiff</li>';
                } else {
                    const items = plaintiffs.map((section, index) => {
                        const rawName = extractNameFromSection(section) || `Plaintiff #${index + 1}`;
                        const name = escapeHtml(rawName);
                        const headYes = section.querySelector('input[name$="-head"][value="yes"]');
                        const isHead = headYes && headYes.checked;
                        const typeInput = section.querySelector('input[name$="-type"]');
                        const typeValue = typeInput ? typeInput.value.trim() : '';
                        const ageInput = section.querySelector('input[name$="-age"]:checked');
                        const ageValue = ageInput ? toTitleCase(ageInput.value.trim()) : '';
                        const unitInput = section.querySelector('input[name$="-unit"]');
                        const unitValue = unitInput ? unitInput.value.trim() : '';
                        const details = [];
                        if (typeValue) {
                            details.push(escapeHtml(typeValue));
                        }
                        if (ageValue) {
                            details.push(escapeHtml(ageValue));
                        }
                        const detailText = details.length ? ` (${details.join(', ')})` : '';
                        const unitText = isHead && unitValue ? ` - Unit ${escapeHtml(unitValue)}` : '';
                        const star = isHead ? '<span class="summary-star">*</span>' : '';
                        return `<li>${name}${detailText}${unitText}${star}</li>`;
                    }).join('');
                    plaintiffList.innerHTML = items;
                }
            }

            const defendantList = document.getElementById('summary-defendant-list');
            if (defendantList) {
                if (defendants.length === 0) {
                    defendantList.innerHTML = '<li class="summary-empty">Add first defendant</li>';
                } else {
                    const items = defendants.map((section, index) => {
                        const rawName = extractNameFromSection(section) || `Defendant #${index + 1}`;
                        const name = escapeHtml(rawName);
                        const typeInput = section.querySelector('input[name$="-entity"]');
                        const typeValue = typeInput ? typeInput.value.trim() : '';
                        const roleInput = section.querySelector('input[name$="-role"]:checked');
                        const roleValue = roleInput ? toTitleCase(roleInput.value.trim()) : '';
                        const details = [];
                        if (typeValue) {
                            details.push(escapeHtml(typeValue));
                        }
                        if (roleValue) {
                            details.push(escapeHtml(roleValue));
                        }
                        const detailText = details.length ? ` (${details.join(', ')})` : '';
                        return `<li>${name}${detailText}</li>`;
                    }).join('');
                    defendantList.innerHTML = items;
                }
            }

            const footnote = document.getElementById('summary-footnote');
            if (footnote) {
                const hasHeadOfHousehold = plaintiffs.some(section => {
                    const headYes = section.querySelector('input[name$="-head"][value="yes"]');
                    return headYes && headYes.checked;
                });
                if (hasHeadOfHousehold) {
                    footnote.textContent = '* indicates head of household';
                    footnote.classList.remove('hidden');
                } else {
                    footnote.classList.add('hidden');
                }
            }
        }

        /**
         * Debug function to check form state
         */
        function debugFormState() {
            const form = document.getElementById('main-form');
            const submitBtn = form ? form.querySelector('button[type="submit"]') : null;
            console.log('Form Debug:', {
                formExists: !!form,
                formHandlerAttached: form ? form.hasAttribute('data-handler-attached') : false,
                submitBtnExists: !!submitBtn,
                submitBtnHandlerAttached: submitBtn ? submitBtn.hasAttribute('data-click-handler') : false,
                plaintiffCount: document.getElementById('plaintiffs-container').children.length,
                defendantCount: document.getElementById('defendants-container').children.length
            });
        }

        /**
         * Initialize form and ensure proper event handling
         */
        function initializeForm() {
            // Ensure we have at least one plaintiff and defendant
            const plaintiffsContainer = document.getElementById('plaintiffs-container');
            const defendantsContainer = document.getElementById('defendants-container');

            if (plaintiffsContainer.children.length === 0) {
                addPlaintiff();
            }
            if (defendantsContainer.children.length === 0) {
                addDefendant();
            }

            // Ensure form submission handler is attached
            const form = document.getElementById('main-form');
            if (form) {
                initializeValidation(form);
            }
            if (form && !form.hasAttribute('data-handler-attached')) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Form submit event triggered - validating and showing confirmation popup');
                    if (!runFullValidation(form)) {
                        console.log('Validation prevented submission.');
                        return;
                    }
                    showReviewScreen();
                });
                form.setAttribute('data-handler-attached', 'true');
            }
            if (form && !form.hasAttribute('data-summary-reset')) {
                form.addEventListener('reset', function() {
                    // Wait for the browser to clear the fields before updating the summary.
                    setTimeout(() => {
                        const fields = form.querySelectorAll('input, select, textarea');
                        fields.forEach(field => {
                            delete field.dataset.touched;
                            clearValidationState(field);
                        });
                        updateSummaryPanel();
                    }, 0);
                });
                form.setAttribute('data-summary-reset', 'true');
            }

            // Debug: log form state
            initializeRepeatableSections();
            refreshCollapseToggle('plaintiffs-container');
            refreshCollapseToggle('defendants-container');
            debugFormState();
            updateSummaryPanel();
        }

        /**
         * Initialize form with default plaintiff and defendant on page load
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing form...');
            initializeForm();
            initializeStepper();
            setStepperVisibility(stepperVisible, { focus: false });

            const hideStepperButton = document.getElementById('hide-stepper-button');
            if (hideStepperButton) {
                hideStepperButton.addEventListener('click', () => setStepperVisibility(false));
            }

            const showStepperButton = document.getElementById('show-stepper-button');
            if (showStepperButton) {
                showStepperButton.addEventListener('click', () => setStepperVisibility(true));
            }

            /**
             * Initialize Habitability Intake Form submission handler
             *
             * This handler processes the habitability intake form submission.
             * It collects all form data including:
             * - Personal information (name, email, phone)
             * - Property address details
             * - Client information (rent, move-in date, occupation)
             * - Household and building information
             * - Building issues (electrical, plumbing, HVAC, etc.)
             * - Common area issues (checkboxes for multiple selections)
             * - Pest/vermin issues (checkboxes for different pest types)
             * - Health and safety hazards (checkboxes for various hazards)
             * - Landlord/property manager conduct details
             * - Neighbor/tenant involvement
             * - Document uploads (lease, photos, videos, correspondence)
             * - Submission metadata
             *
             * The form data is currently logged to console and shows an alert.
             * Future enhancement: Send to backend API endpoint for storage and processing.
             */
            const habitabilityForm = document.getElementById('habitability-form');
            if (habitabilityForm) {
                habitabilityForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Habitability form submitted');

                    // Collect form data using FormData API
                    const formData = new FormData(habitabilityForm);
                    const data = {};

                    // Convert FormData to structured object
                    // This handles checkboxes and multiple file uploads by creating arrays
                    for (let [key, value] of formData.entries()) {
                        // Handle checkboxes and multiple values (e.g., pest types, common area issues)
                        if (data[key]) {
                            // If key already exists, convert to array
                            if (Array.isArray(data[key])) {
                                data[key].push(value);
                            } else {
                                data[key] = [data[key], value];
                            }
                        } else {
                            data[key] = value;
                        }
                    }

                    console.log('Habitability form data:', data);

                    // TODO: Backend Integration
                    // Send data to server endpoint for processing and storage
                    // Example:
                    // const response = await fetch('/api/habitability-submissions', {
                    //     method: 'POST',
                    //     headers: { 'Content-Type': 'application/json' },
                    //     body: JSON.stringify(data)
                    // });
                    // const result = await response.json();

                    // For now, just show success message
                    alert('Habitability Intake Form submitted successfully!\n\nThis form submission is not yet connected to the backend. Integration pending.');

                    // Optional: Reset the form after successful submission
                    // habitabilityForm.reset();
                });
            }
        });

        document.addEventListener('input', function(event) {
            if (event.target.closest && event.target.closest('#main-form')) {
                updateSummaryPanel();
            }
        });

        document.addEventListener('change', function(event) {
            if (event.target.closest && event.target.closest('#main-form')) {
                updateSummaryPanel();
            }
        });

        /**
         * Reinitialize form when page becomes visible (handles back/forward navigation)
         */
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible - reinitialize to ensure everything works
                setTimeout(initializeForm, 100);
            }
        });

        /**
         * Handle page show event (fires when navigating back)
         */
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // Page was loaded from cache - reinitialize
                setTimeout(initializeForm, 100);
            }
        });

        /**
         * Update defendant section title based on name fields
         * @param {number} defendantId - The ID number of the defendant section
         */
        function updateDefendantTitle(defendantId) {
            const section = document.getElementById(`defendant-${defendantId}`);
            if (!section) return;

        const firstName = section.querySelector(`[name="defendant-${defendantId}-first-name"]`)?.value || '';
            const lastName = section.querySelector(`[name="defendant-${defendantId}-last-name"]`)?.value || '';
            const titleSpan = section.querySelector('.repeatable-title');
            
            if (!titleSpan) return;

            if (firstName && lastName) {
                titleSpan.textContent = `${firstName} ${lastName}`;
            } else if (firstName) {
                titleSpan.textContent = firstName;
            } else {
                titleSpan.textContent = `Defendant #${defendantId}`;
            }
        }

        /**
         * Update plaintiff section title based on name fields
         * @param {number} plaintiffId - The ID number of the plaintiff section
         */
        function updatePlaintiffTitle(plaintiffId) {
            const section = document.getElementById(`plaintiff-${plaintiffId}`);
            if (!section) return;

            const firstName = section.querySelector(`[name="plaintiff-${plaintiffId}-first-name"]`)?.value || '';
            const lastName = section.querySelector(`[name="plaintiff-${plaintiffId}-last-name"]`)?.value || '';
            const titleSpan = section.querySelector('.repeatable-title');
            
            if (!titleSpan) return;

            if (firstName && lastName) {
                titleSpan.textContent = `${firstName} ${lastName}`;
            } else if (firstName) {
                titleSpan.textContent = firstName;
            } else {
                titleSpan.textContent = `Plaintiff #${plaintiffId}`;
            }
        }

        /**
         * Add a new plaintiff section to the form
         * Creates a complete plaintiff form with all required fields and conditional sections.
         * Includes comprehensive issue tracking categories and enhanced user interaction.
         *
         * Features:
         * - Dynamic section titles that update with plaintiff names
         * - Basic plaintiff information fields with real-time updates
         * - Age category selection (Adult/Child)
         * - Head of household designation with conditional issue tracking
         * - Comprehensive issue categories with expandable sections
         * - Enhanced clickable areas for better user experience
         * - Smart header display showing full name when collapsed
         */
        function addPlaintiff() {
            plaintiffCounter++;
            const container = document.getElementById('plaintiffs-container');
            const plaintiffDiv = document.createElement('div');
            plaintiffDiv.className = 'repeatable-section';
            plaintiffDiv.id = `plaintiff-${plaintiffCounter}`;

            plaintiffDiv.innerHTML = `
                <div class="repeatable-header">
                    <button type="button" class="repeatable-toggle" id="plaintiff-${plaintiffCounter}-toggle" aria-expanded="true" aria-controls="plaintiff-${plaintiffCounter}-content">
                        <span class="repeatable-title">Plaintiff #${plaintiffCounter}</span>
                        <span class="repeatable-indicator" aria-hidden="true"><i class="fas fa-chevron-down"></i></span>
                    </button>
                    <button type="button" class="btn btn-remove" onclick="removePlaintiff(${plaintiffCounter})" title="Remove Plaintiff"><i class="fa-regular fa-trash-can"></i></button>
                </div>
                <div class="repeatable-content" id="plaintiff-${plaintiffCounter}-content" role="region" aria-labelledby="plaintiff-${plaintiffCounter}-toggle">
                    <h4 style="margin-top: 15px;">Basic Information</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>First Name:</label>
                            <input type="text" name="plaintiff-${plaintiffCounter}-first-name" oninput="updatePlaintiffTitle(${plaintiffCounter})" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name:</label>
                            <input type="text" name="plaintiff-${plaintiffCounter}-last-name" oninput="updatePlaintiffTitle(${plaintiffCounter})" required>
                        </div>
                        <div class="form-group">
                            <label>Plaintiff Type</label>
                            <input type="text" name="plaintiff-${plaintiffCounter}-type" placeholder="e.g., Individual, Guardian, etc.">
                        </div>
                        <div class="form-group">
                            <label>Age Category:</label>
                            <div class="radio-group inline">
                                <div class="radio-item" onclick="selectRadio('plaintiff-${plaintiffCounter}-age-adult')">
                                    <input type="radio" id="plaintiff-${plaintiffCounter}-age-adult" name="plaintiff-${plaintiffCounter}-age" value="adult" checked>
                                    <label for="plaintiff-${plaintiffCounter}-age-adult">Adult</label>
                                </div>
                                <div class="radio-item" onclick="selectRadio('plaintiff-${plaintiffCounter}-age-child')">
                                    <input type="radio" id="plaintiff-${plaintiffCounter}-age-child" name="plaintiff-${plaintiffCounter}-age" value="child">
                                    <label for="plaintiff-${plaintiffCounter}-age-child">Child</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Head of Household</label>
                            <div class="radio-group inline">
                                <div class="radio-item" onclick="selectRadio('plaintiff-${plaintiffCounter}-head-yes')">
                                    <input type="radio" id="plaintiff-${plaintiffCounter}-head-yes" name="plaintiff-${plaintiffCounter}-head" value="yes" onchange="toggleHouseholdUnit(${plaintiffCounter}, this.value)">
                                    <label for="plaintiff-${plaintiffCounter}-head-yes">Yes</label>
                                </div>
                                <div class="radio-item" onclick="selectRadio('plaintiff-${plaintiffCounter}-head-no')">
                                    <input type="radio" id="plaintiff-${plaintiffCounter}-head-no" name="plaintiff-${plaintiffCounter}-head" value="no" checked onchange="toggleHouseholdUnit(${plaintiffCounter}, this.value)">
                                    <label for="plaintiff-${plaintiffCounter}-head-no">No</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="household-sections-${plaintiffCounter}" class="conditional-section hidden">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 20px;">
                            <h4><i class="fas fa-home"></i> Head of Household Information</h4>
                            <div class="form-group unit-field" style="margin: 0; max-width: 250px; display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;">
                                <label style="margin-bottom: 0; white-space: nowrap;">Unit Number (if any):</label>
                                <input type="text" name="plaintiff-${plaintiffCounter}-unit">
                            </div>
                        </div>

                        ${generateIssueCategories(plaintiffCounter)}
                    </div>
                </div>
            `;

            container.appendChild(plaintiffDiv);
            initializeRepeatableSection(plaintiffDiv);
            initializeValidation(plaintiffDiv);
            updateSummaryPanel();
        }

        /**
         * Add a new defendant section to the form
         * Creates a complete defendant form with all required fields.
         *
         * Features:
         * - Dynamic section titles that update with defendant names
         * - Basic defendant information (name, entity type)
         * - Role designation (Manager/Owner)
         * - Clean interface without icons for professional appearance
         * - Proper validation and data collection
         * - Smart header display showing full name when collapsed
         */
        function addDefendant() {
            defendantCounter++;
            const container = document.getElementById('defendants-container');
            const defendantDiv = document.createElement('div');
            defendantDiv.className = 'repeatable-section';
            defendantDiv.id = `defendant-${defendantCounter}`;

            defendantDiv.innerHTML = `
                <div class="repeatable-header">
                    <button type="button" class="repeatable-toggle" id="defendant-${defendantCounter}-toggle" aria-expanded="true" aria-controls="defendant-${defendantCounter}-content">
                        <span class="repeatable-title">Defendant #${defendantCounter}</span>
                        <span class="repeatable-indicator" aria-hidden="true"><i class="fas fa-chevron-down"></i></span>
                    </button>
                    <button type="button" class="btn btn-remove" onclick="removeDefendant(${defendantCounter})" title="Remove Defendant"><i class="fa-regular fa-trash-can"></i></button>
                </div>
                <div class="repeatable-content" id="defendant-${defendantCounter}-content" role="region" aria-labelledby="defendant-${defendantCounter}-toggle">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>First Name:</label>
                            <input type="text" name="defendant-${defendantCounter}-first-name" oninput="updateDefendantTitle(${defendantCounter})" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name:</label>
                            <input type="text" name="defendant-${defendantCounter}-last-name" oninput="updateDefendantTitle(${defendantCounter})" required>
                        </div>
                        <div class="form-group">
                            <label>Defendant Type</label>
                            <input type="text" name="defendant-${defendantCounter}-entity" placeholder="e.g., Individual, LLC, Corporation, etc.">
                        </div>
                        <div class="form-group">
                            <label>Manager or Owner</label>
                            <div class="radio-group">
                                <div class="radio-item" onclick="selectRadio('defendant-${defendantCounter}-role-manager')">
                                    <input type="radio" id="defendant-${defendantCounter}-role-manager" name="defendant-${defendantCounter}-role" value="manager">
                                    <label for="defendant-${defendantCounter}-role-manager">Manager</label>
                                </div>
                                <div class="radio-item" onclick="selectRadio('defendant-${defendantCounter}-role-owner')">
                                    <input type="radio" id="defendant-${defendantCounter}-role-owner" name="defendant-${defendantCounter}-role" value="owner">
                                    <label for="defendant-${defendantCounter}-role-owner">Owner</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(defendantDiv);
            initializeRepeatableSection(defendantDiv);
            initializeValidation(defendantDiv);
            updateSummaryPanel();
        }

        // Expose functions globally for access from external modules (e.g., form-submission.js)
        window.addPlaintiff = addPlaintiff;
        window.addDefendant = addDefendant;

        /**
         * Remove a plaintiff section from the form
         * @param {number} id - The ID of the plaintiff to remove
         */
        function removePlaintiff(id) {
            const element = document.getElementById(`plaintiff-${id}`);
            if (element) {
                element.remove();
                renumberPlaintiffs();
            }
        }

        /**
         * Remove a defendant section from the form
         * @param {number} id - The ID of the defendant to remove
         */
        function removeDefendant(id) {
            const element = document.getElementById(`defendant-${id}`);
            if (element) {
                element.remove();
                renumberDefendants();
            }
        }

        /**
         * Renumber all plaintiffs after removal to maintain sequential numbering
         *
         * PURPOSE:
         * When a plaintiff is removed from the form, this function ensures that all remaining
         * plaintiffs are renumbered sequentially (1, 2, 3...) without gaps. This is critical
         * for maintaining data integrity and a clean user experience.
         *
         * WHAT IT DOES:
         * 1. Iterates through all remaining plaintiff sections in the DOM
         * 2. Reassigns each section a sequential number based on its position (0-indexed + 1)
         * 3. Updates all related HTML attributes, IDs, and event handlers to reflect the new number
         * 4. Syncs the global plaintiffCounter variable to match the actual count
         *
         * UPDATED ELEMENTS:
         * - Section ID: plaintiff-X → plaintiff-Y
         * - Header text: "Plaintiff #X" → "Plaintiff #Y"
         * - Remove button onclick: removePlaintiff(X) → removePlaintiff(Y)
         * - Form field names: plaintiff-X-first-name → plaintiff-Y-first-name
         * - Form field IDs: plaintiff-X-age-adult → plaintiff-Y-age-adult
         * - Label for attributes: Match updated input IDs
         * - Radio button onclick handlers: Match updated radio IDs
         * - Onchange attributes: Match updated function parameters
         * - Household section IDs: household-sections-X → household-sections-Y
         *
         * WHY THIS MATTERS:
         * - Backend expects sequential plaintiff numbers (plaintiff-1, plaintiff-2, etc.)
         * - Gaps in numbering would cause data loss or parsing errors
         * - User experience: Sequential numbering is intuitive and professional
         * - Form validation: Prevents issues with duplicate or missing plaintiff data
         *
         * EXAMPLE SCENARIO:
         * Initial state: Plaintiff #1, Plaintiff #2, Plaintiff #3
         * User deletes: Plaintiff #1
         * Before renumbering: [deleted], Plaintiff #2, Plaintiff #3
         * After renumbering: Plaintiff #1 (was #2), Plaintiff #2 (was #3)
         *
         * @returns {void}
         */
        function renumberPlaintiffs() {
            const container = document.getElementById('plaintiffs-container');
            const sections = container.querySelectorAll('.repeatable-section');

            sections.forEach((section, index) => {
                const newNumber = index + 1;
                const oldId = section.id;
                const oldNumber = oldId.replace('plaintiff-', '');

                // Update section ID
                section.id = `plaintiff-${newNumber}`;

                // Update header number
                const toggleButton = section.querySelector('.repeatable-toggle');
                if (toggleButton) {
                    toggleButton.id = `plaintiff-${newNumber}-toggle`;
                    toggleButton.setAttribute('aria-controls', `plaintiff-${newNumber}-content`);
                }

                const title = section.querySelector('.repeatable-title');
                if (title) {
                    title.textContent = `Plaintiff #${newNumber}`;
                }

                const content = section.querySelector('.repeatable-content');
                if (content) {
                    content.id = `plaintiff-${newNumber}-content`;
                    content.setAttribute('aria-labelledby', `plaintiff-${newNumber}-toggle`);
                }

                // Update remove button onclick
                const removeBtn = section.querySelector('.btn-remove');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removePlaintiff(${newNumber})`);
                }

                // Update all form field names and IDs
                const inputs = section.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(`plaintiff-${oldNumber}-`, `plaintiff-${newNumber}-`);
                    }
                    if (input.id) {
                        input.id = input.id.replace(`plaintiff-${oldNumber}-`, `plaintiff-${newNumber}-`);
                    }
                    // Update onchange attributes
                    if (input.getAttribute('onchange')) {
                        input.setAttribute('onchange', input.getAttribute('onchange').replace(oldNumber, newNumber));
                    }
                });

                // Update all labels for attributes
                const labels = section.querySelectorAll('label[for]');
                labels.forEach(label => {
                    if (label.getAttribute('for')) {
                        label.setAttribute('for', label.getAttribute('for').replace(`plaintiff-${oldNumber}-`, `plaintiff-${newNumber}-`));
                    }
                });

                // Update radio item onclick attributes
                const radioItems = section.querySelectorAll('.radio-item[onclick]');
                radioItems.forEach(item => {
                    const onclick = item.getAttribute('onclick');
                    if (onclick) {
                        item.setAttribute('onclick', onclick.replace(`plaintiff-${oldNumber}-`, `plaintiff-${newNumber}-`));
                    }
                });

                // Update household sections ID
                const householdSection = section.querySelector(`#household-sections-${oldNumber}`);
                if (householdSection) {
                    householdSection.id = `household-sections-${newNumber}`;
                }
            });

            // Update plaintiff counter to match the last number
            plaintiffCounter = sections.length;
            updateSummaryPanel();
            refreshCollapseToggle('plaintiffs-container');
        }

        /**
         * Renumber all defendants after removal to maintain sequential numbering
         *
         * PURPOSE:
         * When a defendant is removed from the form, this function ensures that all remaining
         * defendants are renumbered sequentially (1, 2, 3...) without gaps. This maintains
         * consistency with backend data processing and provides a clean user interface.
         *
         * WHAT IT DOES:
         * 1. Iterates through all remaining defendant sections in the DOM
         * 2. Reassigns each section a sequential number based on its position (0-indexed + 1)
         * 3. Updates all related HTML attributes, IDs, and event handlers to reflect the new number
         * 4. Syncs the global defendantCounter variable to match the actual count
         *
         * UPDATED ELEMENTS:
         * - Section ID: defendant-X → defendant-Y
         * - Header text: "Defendant #X" → "Defendant #Y"
         * - Remove button onclick: removeDefendant(X) → removeDefendant(Y)
         * - Form field names: defendant-X-first-name → defendant-Y-first-name
         * - Form field IDs: defendant-X-role-manager → defendant-Y-role-manager
         * - Label for attributes: Match updated input IDs
         * - Radio button onclick handlers: Match updated radio IDs
         *
         * WHY THIS MATTERS:
         * - Backend transformation logic expects sequential defendant numbers
         * - Prevents data processing errors from gaps in numbering
         * - Maintains professional appearance and user experience
         * - Ensures form data integrity during submission
         *
         * EXAMPLE SCENARIO:
         * Initial state: Defendant #1, Defendant #2, Defendant #3
         * User deletes: Defendant #2
         * Before renumbering: Defendant #1, [deleted], Defendant #3
         * After renumbering: Defendant #1, Defendant #2 (was #3)
         *
         * NOTE:
         * This function works identically to renumberPlaintiffs() but operates on
         * defendant sections. The simpler structure (no household sections) makes
         * the renumbering process slightly less complex than plaintiff renumbering.
         *
         * @returns {void}
         */
        function renumberDefendants() {
            const container = document.getElementById('defendants-container');
            const sections = container.querySelectorAll('.repeatable-section');

            sections.forEach((section, index) => {
                const newNumber = index + 1;
                const oldId = section.id;
                const oldNumber = oldId.replace('defendant-', '');

                // Update section ID
                section.id = `defendant-${newNumber}`;

                // Update header number
                const toggleButton = section.querySelector('.repeatable-toggle');
                if (toggleButton) {
                    toggleButton.id = `defendant-${newNumber}-toggle`;
                    toggleButton.setAttribute('aria-controls', `defendant-${newNumber}-content`);
                }

                const title = section.querySelector('.repeatable-title');
                if (title) {
                    title.textContent = `Defendant #${newNumber}`;
                }

                const content = section.querySelector('.repeatable-content');
                if (content) {
                    content.id = `defendant-${newNumber}-content`;
                    content.setAttribute('aria-labelledby', `defendant-${newNumber}-toggle`);
                }

                // Update remove button onclick
                const removeBtn = section.querySelector('.btn-remove');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeDefendant(${newNumber})`);
                }

                // Update all form field names and IDs
                const inputs = section.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(`defendant-${oldNumber}-`, `defendant-${newNumber}-`);
                    }
                    if (input.id) {
                        input.id = input.id.replace(`defendant-${oldNumber}-`, `defendant-${newNumber}-`);
                    }
                });

                // Update all labels for attributes
                const labels = section.querySelectorAll('label[for]');
                labels.forEach(label => {
                    if (label.getAttribute('for')) {
                        label.setAttribute('for', label.getAttribute('for').replace(`defendant-${oldNumber}-`, `defendant-${newNumber}-`));
                    }
                });

                // Update radio item onclick attributes
                const radioItems = section.querySelectorAll('.radio-item[onclick]');
                radioItems.forEach(item => {
                    const onclick = item.getAttribute('onclick');
                    if (onclick) {
                        item.setAttribute('onclick', onclick.replace(`defendant-${oldNumber}-`, `defendant-${newNumber}-`));
                    }
                });
            });

            // Update defendant counter to match the last number
            defendantCounter = sections.length;
            updateSummaryPanel();
            refreshCollapseToggle('defendants-container');
        }

        /**
         * Toggle visibility of household information section
         * @param {number} plaintiffId - The ID of the plaintiff
         * @param {string} value - 'yes' or 'no' indicating head of household status
         */
        function toggleHouseholdUnit(plaintiffId, value) {
            const householdSections = document.getElementById(`household-sections-${plaintiffId}`);
            if (value === 'yes') {
                householdSections.classList.remove('hidden');
            } else {
                householdSections.classList.add('hidden');
            }
            updateSummaryPanel();
        }

        /**
         * Toggle visibility of issue category details
         * @param {number} plaintiffId - The ID of the plaintiff
         * @param {string} category - The category name
         * @param {HTMLElement} checkbox - The checkbox element that triggered the toggle
         */
        function toggleIssueCategory(plaintiffId, category, checkbox) {
            setCategoryExpansion(plaintiffId, category, checkbox.checked);
        }

        /**
         * Generate HTML for all issue categories and direct yes/no issues
         * Creates comprehensive issue tracking interface with enhanced user experience.
         *
         * @param {number} plaintiffId - The ID of the plaintiff
         * @returns {string} HTML string for all issue categories
         *
         * Features:
         * - Accessible accordion headers that sync aria-expanded with checkbox state
         * - Comprehensive issue categorization covering all legal concerns
         * - Direct yes/no toggles for simple binary issues
         * - Enhanced UI with proper hover states and visual feedback
         * - Structured data collection for accurate legal documentation
         *
         * Categories Include:
         * - Vermin, Insect, HVAC, Electrical, Fire Hazard issues
         * - Government entity contacts, Plumbing, Structural problems
         * - Safety, Utility, Harassment, and Discrimination issues
         * - Plus direct yes/no issues for quick classification
         */
        function generateIssueCategories(plaintiffId) {
            const categories = [
                // Row 1
                {
                    name: 'vermin',
                    title: 'Vermin Issues',
                    items: ['Rats / Mice', 'Bats', 'Pigeons', 'Skunks', 'Raccoons', 'Opossums']
                },
                {
                    name: 'insect',
                    title: 'Insect Issues',
                    items: ['Ants', 'Bedbugs', 'Spiders', 'Mosquitos', 'Roaches', 'Wasps', 'Termites', 'Bees', 'Flies', 'Hornets']
                },
                // Row 2
                {
                    name: 'hvac',
                    title: 'HVAC Issues',
                    items: ['Air Conditioner', 'Heater', 'Ventilation']
                },
                {
                    name: 'electrical',
                    title: 'Electrical Issues',
                    items: ['Outlets', 'Wall Switches', 'Interior Lighting', 'Fans', 'Panel', 'Exterior Lighting', 'Light Fixtures']
                },
                // Row 3
                {
                    name: 'fire-hazard',
                    title: 'Fire Hazard Issues',
                    items: ['Smoke Alarms', 'Non-compliant electricity', 'Carbon monoxide detectors', 'Fire Extinguisher', 'Non-GFI outlets near water']
                },
                {
                    name: 'government',
                    title: 'Government Entity Contacted',
                    items: ['Health Department', 'Police Department', 'Housing Authority', 'Department of Environmental Health', 'Code Enforcement', 'Department of Health Services', 'Fire Department']
                },
                // Row 4
                {
                    name: 'plumbing',
                    title: 'Plumbing Issues',
                    items: ['Toilet', 'Insufficient water pressure', 'Clogged bath', 'Shower', 'No hot water', 'Clogged sinks', 'Bath', 'No cold water', 'Clogged shower', 'Fixtures', 'Sewage coming out', 'No Clean Water Supply', 'Leaks', 'Clogged toilets', 'Unsanitary water']
                },
                {
                    name: 'structure',
                    title: 'Structure Issues',
                    items: ['Bumps in ceiling', 'Hole in ceiling', 'Water stains on ceiling', 'Water stains on wall', 'Hole in wall', 'Paint', 'Exterior deck/porch', 'Waterproof toilet', 'Waterproof tub', 'Staircase', 'Basement flood', 'Leaks in garage', 'Soft Spots due to Leaks', 'Uneffective Waterproofing of the tubs or toilet', 'Ineffective Weatherproofing of any windows']
                },
                // Row 5
                {
                    name: 'flooring',
                    title: 'Flooring Issues',
                    items: ['Uneven', 'Carpet', 'Nails sticking out', 'Tiles']
                },
                {
                    name: 'cabinets',
                    title: 'Cabinets Issues',
                    items: ['Broken', 'Hinges', 'Alignment']
                },
                // Row 6
                {
                    name: 'door',
                    title: 'Door Issues',
                    items: ['Broken', 'Broken hinges', 'Water intrusion and/or insects', 'Knobs', 'Sliding glass doors', 'Do not close properly', 'Locks', 'Ineffective waterproofing']
                },
                {
                    name: 'windows',
                    title: 'Windows Issues',
                    items: ['Broken', 'Leaks', 'Missing windows', 'Screens', 'Do not lock', 'Broken or missing screens']
                },
                // Row 7
                {
                    name: 'nuisance',
                    title: 'Nuisance Issues',
                    items: ['Drugs', 'Smoking', 'Noisy neighbors', 'Gangs']
                },
                {
                    name: 'trash',
                    title: 'Trash Problems',
                    items: ['Inadequate number of receptacles', 'Improper servicing/emptying']
                },
                // Row 8
                {
                    name: 'common-areas',
                    title: 'Common Areas Issues',
                    items: ['Mailbox broken', 'Parking area issues', 'Damage to cars', 'Flooding', 'Entrances blocked', 'Swimming pool', 'Jacuzzi', 'Laundry room', 'Recreation room', 'Gym', 'Broken Gate', 'Elevator', 'Blocked areas/doors', 'Filth / Rubbish / Garbage', 'Vermin', 'Insects']
                },
                {
                    name: 'health-hazard',
                    title: 'Health Hazard Issues',
                    items: ['Mold', 'Mildew', 'Mushrooms', 'Noxious fumes', 'Toxic water pollution', 'Raw sewage on exterior', 'Chemical/paint contamination', 'Offensive odors']
                },
                // Row 9
                {
                    name: 'appliances',
                    title: 'Appliance Issues',
                    items: ['Stove', 'Dishwasher', 'Washer/dryer', 'Oven', 'Microwave', 'Garbage disposal', 'Refrigerator']
                },
                {
                    name: 'notices',
                    title: 'Notices Issues',
                    items: ['3-day', '24-hour', '30-day', '60-day', 'To quit', 'Perform or quit']
                },
                // Row 10
                {
                    name: 'utility',
                    title: 'Utility Issues',
                    items: ['Gas leak', 'Gas shutoff', 'Electricity shutoffs', 'Water shutoffs', 'Heat shutoff']
                },
                {
                    name: 'safety',
                    title: 'Safety Issues',
                    items: ['Broken / inoperable security gate', 'Unauthorized entries', 'Security cameras', 'Broken doors', 'Broken buzzer to get in', 'Inoperable locks']
                },
                // Row 11 - Spans both columns
                {
                    name: 'harassment',
                    title: 'Harassment Issues',
                    items: ['Unlawful Detainer', 'Eviction threats', 'By defendant', 'By maintenance man/workers', 'By manager/building staff', 'By owner', 'Other tenants', 'Illegitimate notices', 'Refusal to make timely repairs', 'Written threats', 'Aggressive/inappropriate language', 'Physical threats or touching', 'Notices singling out one tenant, but not uniformly given to all tenants', 'Duplicative notices', 'Untimely Response from Landlord'],
                    spanBoth: true
                }
            ];

            const simpleToggles = [
                'Injury Issues',
                'Nonresponsive Landlord Issues',
                'Unauthorized Entries',
                'Stolen Items',
                'Disability Discrimination',
                'Damaged Items',
                'Age Discrimination',
                'Racial Discrimination',
                'Security Deposit Issues'
            ];

            let html = '<h4>Issue Categories</h4>';
            html += '<div class="issue-categories-grid">';

            // Generate complex categories with checkboxes
            categories.forEach(category => {
                const spanClass = category.spanBoth ? ' span-both' : '';
                html += `
                    <div class="toggle-section${spanClass}">
                        <div class="toggle-header">
                            <div class="toggle-checkbox">
                                <input type="checkbox" id="${category.name}-toggle-${plaintiffId}" aria-label="Select ${category.title}" onchange="toggleIssueCategory(${plaintiffId}, '${category.name}', this)">
                            </div>
                            <button type="button" class="toggle-button" id="${category.name}-button-${plaintiffId}" aria-expanded="false" aria-controls="${category.name}-content-${plaintiffId}" onclick="toggleCategoryContent(${plaintiffId}, '${category.name}')">
                                <span class="toggle-title">${category.title}</span>
                                <span class="toggle-indicator" aria-hidden="true"><i class="fas fa-chevron-down"></i></span>
                            </button>
                        </div>
                        <div class="toggle-content" id="${category.name}-content-${plaintiffId}" role="region" aria-labelledby="${category.name}-button-${plaintiffId}" hidden>
                            <div class="checkbox-group">
                                ${category.items.map(item => `
                                    <div class="checkbox-item" onclick="toggleCheckbox('${category.name}-${item.replace(/[^a-zA-Z0-9]/g, '')}-${plaintiffId}')">
                                        <input type="checkbox" id="${category.name}-${item.replace(/[^a-zA-Z0-9]/g, '')}-${plaintiffId}" name="${category.name}-${item.replace(/[^a-zA-Z0-9]/g, '')}-${plaintiffId}">
                                        <label for="${category.name}-${item.replace(/[^a-zA-Z0-9]/g, '')}-${plaintiffId}">${item}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            // Generate simple yes/no toggles
            html += '<h4>Direct Yes/No Issues</h4>';
            html += '<div class="direct-issues-grid">';
            simpleToggles.forEach(toggle => {
                const id = toggle.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                html += `
                    <div class="direct-issue-item" onclick="toggleCheckbox('direct-${id}-${plaintiffId}')">
                        <input type="checkbox" id="direct-${id}-${plaintiffId}" name="direct-${id}-${plaintiffId}">
                        <label for="direct-${id}-${plaintiffId}">${toggle}</label>
                    </div>
                `;
            });
            html += '</div>';

            return html;
        }

        /**
         * Toggle checkbox when clicking on entire checkbox item
         * @param {string} checkboxId - The ID of the checkbox to toggle
         */
        function toggleCheckbox(checkboxId) {
            const checkbox = document.getElementById(checkboxId);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }

        /**
         * Set the expanded state of a category accordion and sync ARIA attributes
         * @param {number} plaintiffId - The ID of the plaintiff
         * @param {string} category - The category name
         * @param {boolean} expanded - Whether the accordion should be expanded
         */
        function setCategoryExpansion(plaintiffId, category, expanded) {
            const button = document.getElementById(`${category}-button-${plaintiffId}`);
            const content = document.getElementById(`${category}-content-${plaintiffId}`);
            if (!button || !content) {
                return;
            }
            button.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            content.classList.toggle('show', expanded);
            content.toggleAttribute('hidden', !expanded);
        }

        /**
         * Toggle a category accordion open or closed via its button
         * @param {number} plaintiffId - The ID of the plaintiff
         * @param {string} category - The category name
         */
        function toggleCategoryContent(plaintiffId, category) {
            const button = document.getElementById(`${category}-button-${plaintiffId}`);
            if (!button) {
                return;
            }
            const checkbox = document.getElementById(`${category}-toggle-${plaintiffId}`);
            const expanded = button.getAttribute('aria-expanded') !== 'true';

            if (checkbox) {
                if (checkbox.checked !== expanded) {
                    checkbox.checked = expanded;
                }
                const changeEvent = new Event('change', { bubbles: true });
                checkbox.dispatchEvent(changeEvent);
            } else {
                setCategoryExpansion(plaintiffId, category, expanded);
            }
        }

        /**
         * Select radio button when clicking on entire radio item
         * @param {string} radioId - The ID of the radio button to select
         */
        function selectRadio(radioId) {
            const radio = document.getElementById(radioId);
            if (radio) {
                radio.checked = true;
                // Trigger the onchange event manually
                const event = new Event('change', { bubbles: true });
                radio.dispatchEvent(event);
            }
        }


        /**
         * Show confirmation modal before form submission
         * Displays a styled confirmation dialog for the user to review before submitting
         */
        function showReviewScreen() {
            console.log('showReviewScreen called - showing confirmation modal');

            try {
                const form = document.getElementById('main-form');
                if (!form) {
                    console.error('Form not found');
                    alert('Form not found');
                    return;
                }

                // Show the custom confirmation modal
                const modal = document.getElementById('confirmationModal');
                modal.classList.add('show');

                // Add click handler to close modal when clicking outside
                modal.onclick = function(event) {
                    if (event.target === modal) {
                        closeConfirmationModal();
                    }
                };

            } catch (error) {
                console.error('Error showing confirmation modal:', error);
                alert('Error: ' + error.message + '. Please try again.');
            }
        }

        /**
         * Close the confirmation modal without submitting
         */
        function closeConfirmationModal() {
            console.log('User cancelled submission');
            const modal = document.getElementById('confirmationModal');
            modal.classList.remove('show');
        }

        /**
         * User confirmed submission - proceed with form submission
         */
        function confirmSubmission() {
            console.log('User confirmed submission - proceeding to email preference');

            closeConfirmationModal();
            showEmailNotificationModal();
        }

        /**
         * Display email notification prompt that mirrors confirmation styling
         * Allows the user to opt in to processing notifications
         */
        function showEmailNotificationModal() {
            const modal = document.getElementById('emailNotificationModal');
            if (!modal) {
                console.warn('Email notification modal not found; submitting without email.');
                submitForm();
                return;
            }

            const emailInput = document.getElementById('notificationEmailInput');
            const errorEl = document.getElementById('notificationEmailError');

            if (emailInput) {
                emailInput.value = '';
                emailInput.focus();
            }

            if (errorEl) {
                errorEl.style.display = 'none';
            }

            modal.classList.add('show');
            modal.onclick = function(event) {
                if (event.target === modal) {
                    skipEmailNotification();
                }
            };
        }

        /**
         * Close the email notification modal
         */
        function closeEmailNotificationModal() {
            const modal = document.getElementById('emailNotificationModal');
            if (modal) {
                modal.classList.remove('show');
                modal.onclick = null;
            }
        }

        // Note: skipEmailNotification and submitEmailNotification functions are imported from form-submission.js
        // They're made available globally by that script

        /**
         * OLD INLINE SUBMIT FUNCTION (BACKUP)
         * This function is replaced by js/form-submission.js
         * Kept for reference/rollback purposes
         */
        async function oldSubmitForm_UNUSED(notificationEmail = null, optedIn = false) {
            try {
                const form = document.getElementById('main-form');
                const formData = new FormData(form);
                const data = {};

                // Convert FormData to regular object, handling multiple values
                for (let [key, value] of formData.entries()) {
                    if (data[key]) {
                        if (Array.isArray(data[key])) {
                            data[key].push(value);
                        } else {
                            data[key] = [data[key], value];
                        }
                    } else {
                        data[key] = value;
                    }
                }

                // Add timestamp and ID for tracking
                const entryData = {
                    id: generateUniqueId(),
                    timestamp: new Date().toISOString(),
                    submittedAt: new Date().toLocaleString(),
                    ...data
                };

                entryData.notificationEmailOptIn = optedIn;
                if (notificationEmail && optedIn) {
                    entryData.notificationEmail = notificationEmail;
                }

                console.log('Submitting form data:', entryData);

                // Show loading state on submit button
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                submitBtn.disabled = true;

                // Removed pipeline toast/polling UI

                // Submit to backend
                const response = await authenticatedFetch('/api/form-entries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(entryData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Form submitted successfully:', result);

                // ============================================================
                // IMMEDIATE FORM RESET - Don't wait for document generation
                // ============================================================
                // The form submission is complete, but document generation
                // happens asynchronously in the background. Reset the form
                // immediately so users can start a new submission while
                // documents are being generated.
                console.log('✅ Form submitted successfully, resetting form immediately...');

                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;

                // Clear the form
                form.reset();

                // Reinitialize with one plaintiff and defendant
                document.getElementById('plaintiffs-container').innerHTML = '';
                document.getElementById('defendants-container').innerHTML = '';
                plaintiffCounter = 0;
                defendantCounter = 0;
                addPlaintiff();
                addDefendant();

                // Background pipeline still runs on the server; no UI polling

            } catch (error) {
                console.error('Error submitting form:', error);

                // Reset button state
                const form = document.getElementById('main-form');
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Form';
                    submitBtn.disabled = false;
                }

                // Keep simple console error; no toast UI

                console.error('❌ Error submitting form:', error.message);
            }
        }

        // ========================================================================
        // UTILITY FUNCTIONS
        // ========================================================================
        // The following utility functions support form data extraction and ID generation.
        //
        // Cleanup Note (2025-10-07):
        // Removed old unused review modal functions that are no longer needed:
        // - generateReviewContent() - Old HTML generation for review modal
        // - generatePlaintiffIssuesReview() - Old issue review content generator
        // - closeReviewModal() - Old modal close handler
        // - submitFormAfterReview() - Old submission handler
        //
        // These have been replaced by the new showReviewScreen() and submitForm() functions
        // which use a cleaner confirmation dialog approach.
        // ========================================================================

        /**
         * Extract plaintiff data from form data
         */
        function extractPlaintiffs(data) {
            const plaintiffs = [];
            let counter = 1;

            while (data[`plaintiff-${counter}-first-name`]) {
                plaintiffs.push({
                    number: counter,
                    firstName: data[`plaintiff-${counter}-first-name`] || '',
                    lastName: data[`plaintiff-${counter}-last-name`] || '',
                    type: data[`plaintiff-${counter}-type`] || '',
                    age: data[`plaintiff-${counter}-age`] || '',
                    headOfHousehold: data[`plaintiff-${counter}-head`] || '',
                    unit: data[`plaintiff-${counter}-unit`] || ''
                });
                counter++;
            }

            return plaintiffs;
        }

        /**
         * Extract defendant data from form data
         */
        function extractDefendants(data) {
            const defendants = [];
            let counter = 1;

            while (data[`defendant-${counter}-first-name`]) {
                defendants.push({
                    number: counter,
                    firstName: data[`defendant-${counter}-first-name`] || '',
                    lastName: data[`defendant-${counter}-last-name`] || '',
                    entity: data[`defendant-${counter}-entity`] || '',
                    role: data[`defendant-${counter}-role`] || ''
                });
                counter++;
            }

            return defendants;
        }

        /**
         * Convert field names to readable text
         */
        function formatFieldName(fieldName) {
            // Create a mapping of common concatenated words to properly formatted versions
            const wordMappings = {
                // Vermin issues
                'ratsmice': 'Rats Mice',
                'bats': 'Bats',
                'pigeons': 'Pigeons',
                'skunks': 'Skunks',
                'raccoons': 'Raccoons',
                'opossums': 'Opossums',
                // Insect issues
                'ants': 'Ants',
                'bedbugs': 'Bedbugs',
                'spiders': 'Spiders',
                'mosquitos': 'Mosquitos',
                'roaches': 'Roaches',
                'wasps': 'Wasps',
                'termites': 'Termites',
                'bees': 'Bees',
                'flies': 'Flies',
                'hornets': 'Hornets',
                // HVAC issues
                'airconditioner': 'Air Conditioner',
                'airconditioning': 'Air Conditioning',
                'heater': 'Heater',
                'ventilation': 'Ventilation',
                // Electrical issues
                'outlets': 'Outlets',
                'wallswitches': 'Wall Switches',
                'interiorlighting': 'Interior Lighting',
                'fans': 'Fans',
                'panel': 'Panel',
                'exteriorlighting': 'Exterior Lighting',
                'lightfixtures': 'Light Fixtures',
                // Fire Hazard issues
                'smokealarms': 'Smoke Alarms',
                'noncompliantelectricity': 'Non-compliant Electricity',
                'carbonmonoxidedetectors': 'Carbon Monoxide Detectors',
                'fireextinguisher': 'Fire Extinguisher',
                'nongfioutletsnearwater': 'Non-GFI Outlets Near Water',
                // Government entities
                'healthdepartment': 'Health Department',
                'policedepartment': 'Police Department',
                'housingauthority': 'Housing Authority',
                'departmentofenvironmentalhealth': 'Department of Environmental Health',
                'codeenforcement': 'Code Enforcement',
                'departmentofhealthservices': 'Department of Health Services',
                'firedepartment': 'Fire Department',
                // Appliances
                'stove': 'Stove',
                'dishwasher': 'Dishwasher',
                'washerdryer': 'Washer/dryer',
                'oven': 'Oven',
                'microwave': 'Microwave',
                'garbagedisposal': 'Garbage Disposal',
                'refrigerator': 'Refrigerator',
                // Plumbing issues
                'toilet': 'Toilet',
                'insufficientwaterpressure': 'Insufficient Water Pressure',
                'cloggedbath': 'Clogged Bath',
                'shower': 'Shower',
                'nohotwater': 'No Hot Water',
                'cloggedsinks': 'Clogged Sinks',
                'bath': 'Bath',
                'nocoldwater': 'No Cold Water',
                'cloggedshower': 'Clogged Shower',
                'fixtures': 'Fixtures',
                'sewagecomingout': 'Sewage Coming Out',
                'nocleanwatersupply': 'No Clean Water Supply',
                'leaks': 'Leaks',
                'cloggedtoilets': 'Clogged Toilets',
                'unsanitarywater': 'Unsanitary Water',
                // Cabinet issues
                'broken': 'Broken',
                'hinges': 'Hinges',
                'alignment': 'Alignment',
                // Flooring issues
                'uneven': 'Uneven',
                'carpet': 'Carpet',
                'nailsstickingout': 'Nails Sticking Out',
                'tiles': 'Tiles',
                // Window issues
                'missingwindows': 'Missing Windows',
                'screens': 'Screens',
                'donotlock': 'Do Not Lock',
                'brokenormissingscreens': 'Broken or Missing Screens',
                // Door issues
                'brokenhinges': 'Broken Hinges',
                'waterintrusionandorinsects': 'Water Intrusion and/or Insects',
                'knobs': 'Knobs',
                'slidingglassdoors': 'Sliding Glass Doors',
                'donotcloseproperly': 'Do Not Close Properly',
                'locks': 'Locks',
                'ineffectivewaterproofing': 'Ineffective Waterproofing',
                // Structure issues
                'bumpsinceiling': 'Bumps in Ceiling',
                'holeinceiling': 'Hole in Ceiling',
                'waterstainsonceiling': 'Water Stains on Ceiling',
                'waterstainsonwall': 'Water Stains on Wall',
                'holeinwall': 'Hole in Wall',
                'paint': 'Paint',
                'exteriordeckporch': 'Exterior Deck/Porch',
                'waterprooftoilet': 'Waterproof Toilet',
                'waterprooftub': 'Waterproof Tub',
                'staircase': 'Staircase',
                'basementflood': 'Basement Flood',
                'leaksingarage': 'Leaks in Garage',
                'softspotsduetoleaks': 'Soft Spots Due to Leaks',
                'uneffectivewaterproofingofthetubsortoilet': 'Uneffective Waterproofing of the Tubs or Toilet',
                'ineffectiveweatherproofingofanywindows': 'Ineffective Weatherproofing of Any Windows',
                // Common areas
                'mailboxbroken': 'Mailbox Broken',
                'parkingareaissues': 'Parking Area Issues',
                'damagetocars': 'Damage to Cars',
                'flooding': 'Flooding',
                'entrancesblocked': 'Entrances Blocked',
                'swimmingpool': 'Swimming Pool',
                'jacuzzi': 'Jacuzzi',
                'laundryroom': 'Laundry Room',
                'recreationroom': 'Recreation Room',
                'gym': 'Gym',
                'brokengate': 'Broken Gate',
                'elevator': 'Elevator',
                'blockedareasdoors': 'Blocked Areas/Doors',
                'filthrubbishgarbage': 'Filth Rubbish Garbage',
                'vermin': 'Vermin',
                'insects': 'Insects',
                // Nuisance issues
                'drugs': 'Drugs',
                'smoking': 'Smoking',
                'noisyneighbors': 'Noisy Neighbors',
                'gangs': 'Gangs',
                // Health hazard issues
                'mold': 'Mold',
                'mildew': 'Mildew',
                'mushrooms': 'Mushrooms',
                'noxiousfumes': 'Noxious Fumes',
                'toxicwaterpollution': 'Toxic Water Pollution',
                'rawsewageonexterior': 'Raw Sewage on Exterior',
                'chemicalpaintcontamination': 'Chemical Paint Contamination',
                'offensiveodors': 'Offensive Odors',
                // Harassment issues
                'unlawfuldetainer': 'Unlawful Detainer',
                'evictionthreats': 'Eviction Threats',
                'bydefendant': 'By Defendant',
                'bymaintenancemanworkers': 'By Maintenance Man/Workers',
                'bymanagerbuildingstaff': 'By Manager/Building Staff',
                'byowner': 'By Owner',
                'othertenants': 'Other Tenants',
                'illegitimatenotices': 'Illegitimate Notices',
                'refusaltomaketimelyrepairs': 'Refusal to Make Timely Repairs',
                'writtenthreats': 'Written Threats',
                'aggressiveinappropriatelanguage': 'Aggressive Inappropriate Language',
                'physicalthreatsortouching': 'Physical Threats or Touching',
                'noticessinglingoutonetenantbutnotuniformlygiventoalltenants': 'Notices Singling Out One Tenant but not Uniformly Given to All Tenants',
                'duplicativenotices': 'Duplicative Notices',
                'untimelyresponsefromlandlord': 'Untimely Response from Landlord',
                // Notice issues
                '3day': '3-Day',
                '24hour': '24-Hour',
                '30day': '30-Day',
                '60day': '60-Day',
                'toquit': 'To Quit',
                'performorquit': 'Perform or Quit',
                // Utility issues
                'gasleak': 'Gas Leak',
                'gasshutoff': 'Gas Shutoff',
                'electricityshutoffs': 'Electricity Shutoffs',
                'watershutoffs': 'Water Shutoffs',
                'heatshutoff': 'Heat Shutoff',
                // Safety issues
                'broken inoperablesecuritygate': 'Broken/Inoperable Security Gate',
                'unauthorizedentries': 'Unauthorized Entries',
                'securitycameras': 'Security Cameras',
                'brokendoors': 'Broken Doors',
                'brokenbuzzertogetin': 'Broken Buzzer to Get In',
                'inoperablelocks': 'Inoperable Locks',
                // Direct issues
                'appliancesissues': 'Appliances Issues',
                'injuryissues': 'Injury Issues',
                'nonresponsivelandlordissues': 'Nonresponsive Landlord Issues',
                'unauthorizedentries': 'Unauthorized Entries',
                'stolenitems': 'Stolen Items',
                'disabilitydiscrimination': 'Disability Discrimination',
                'damageditems': 'Damaged Items',
                'agediscrimination': 'Age Discrimination',
                'racialdiscrimination': 'Racial Discrimination',
                'securitydepositissues': 'Security Deposit Issues'
            };

            // Convert to lowercase for lookup
            const lowerFieldName = fieldName.toLowerCase();

            // Check if we have a specific mapping
            if (wordMappings[lowerFieldName]) {
                return wordMappings[lowerFieldName];
            }

            // If no specific mapping, try to intelligently split the text
            let result = fieldName;

            // Add spaces before capital letters (for camelCase)
            result = result.replace(/([a-z])([A-Z])/g, '$1 $2');

            // Add spaces before numbers
            result = result.replace(/([a-zA-Z])(\d)/g, '$1 $2');
            result = result.replace(/(\d)([a-zA-Z])/g, '$1 $2');

            // Split common concatenated words
            result = result.replace(/([a-z])(and|or|of|in|on|to|the|for)([A-Z])/g, '$1 $2 $3');

            // Capitalize first letter of each word
            result = result.replace(/\b\w/g, l => l.toUpperCase());

            return result.trim();
        }




        /**
         * Generate a unique ID for the form entry
         */
        function generateUniqueId() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 11);
            return `${timestamp}-${random}`;
        }

        // Simple test to verify JavaScript is running
        console.log('JavaScript is loaded and running');

        /**
         * Tab Management Functions
         * Handles switching between form creation and submissions viewing tabs
         */

        // Global variable to store submissions data
        let submissionsData = [];
        let filteredSubmissions = [];

        /**
         * Show specific tab and hide others
         * @param {string} tabName - The name of the tab to show ('form', 'habitability', or 'submissions')
         */
        function showTab(tabName) {
            // Update tab buttons
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');

            // Toggle summary panel visibility (only show for Document Generation Form)
            const summaryPanel = document.querySelector('.summary-panel');
            if (summaryPanel) {
                summaryPanel.classList.toggle('hidden', tabName !== 'form');
            }
            const layout = document.querySelector('.page-layout');
            if (layout) {
                layout.classList.toggle('summary-visible', tabName === 'form');
            }
            applyStepperForTab(tabName === 'form');

            // Load submissions data when switching to submissions tab
            if (tabName === 'submissions') {
                loadSubmissions();
            }
        }

        /**
         * Load submissions from the backend API
         * Fetches all form submissions and displays them in the submissions tab
         */
        async function loadSubmissions() {
            const loadingEl = document.getElementById('submissions-loading');
            const errorEl = document.getElementById('submissions-error');
            const listEl = document.getElementById('submissions-list');
            const noSubmissionsEl = document.getElementById('no-submissions');

            // Show loading state
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            listEl.style.display = 'none';
            noSubmissionsEl.style.display = 'none';

            try {
                console.log('Loading submissions from API...');
                const response = await authenticatedFetch('/api/form-entries');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Submissions loaded:', data);

                submissionsData = data.entries || [];
                filteredSubmissions = [...submissionsData];

                // Hide loading and show content
                loadingEl.style.display = 'none';

                if (submissionsData.length === 0) {
                    noSubmissionsEl.style.display = 'block';
                } else {
                    listEl.style.display = 'block';
                    displaySubmissions(filteredSubmissions);
                }

                updateStats();

            } catch (error) {
                console.error('Error loading submissions:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'Failed to load submissions: ' + error.message;
            }
        }

        /**
         * Display submissions in the UI
         * @param {Array} submissions - Array of submission objects to display
         */
        function displaySubmissions(submissions) {
            const listEl = document.getElementById('submissions-list');

            if (submissions.length === 0) {
                listEl.innerHTML = '<div class="no-submissions"><i class="fas fa-search"></i><h3>No Submissions Match Your Search</h3><p>Try adjusting your search criteria.</p></div>';
                return;
            }

            // Create table with submissions
            listEl.innerHTML = `
                <table class="submissions-table">
                    <thead>
                        <tr>
                            <th>Street Address</th>
                            <th>Submission Date</th>
                            <th>Time</th>
                            <th>Plaintiff</th>
                            <th>Defendant</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${submissions.map(submission => {
                            const submittedDate = new Date(submission.submittedAt || submission.serverTimestamp);
                            const formattedDate = submittedDate.toLocaleDateString();
                            const formattedTime = submittedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                            return `
                                <tr data-id="${submission.id}">
                                    <td class="street-address-cell">
                                        <strong>${submission.streetAddress || 'Unknown Address'}</strong>
                                    </td>
                                    <td>${formattedDate}</td>
                                    <td>${formattedTime}</td>
                                    <td>${submission.plaintiffCount || 0}</td>
                                    <td>${submission.defendantCount || 0}</td>
                                    <td class="actions-cell">
                                        <button class="btn-icon btn-view" onclick="viewSubmission('${submission.id}')" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn-icon btn-delete" onclick="deleteSubmission('${submission.id}')" title="Delete Submission">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        /**
         * Update statistics displayed on the submissions tab
         */
        function updateStats() {
            const totalEl = document.getElementById('total-submissions');
            const todayEl = document.getElementById('submissions-today');
            const weekEl = document.getElementById('submissions-this-week');

            const total = submissionsData.length;
            const today = new Date();
            const todayStr = today.toDateString();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            const todayCount = submissionsData.filter(sub => {
                const subDate = new Date(sub.submittedAt || sub.serverTimestamp);
                return subDate.toDateString() === todayStr;
            }).length;

            const weekCount = submissionsData.filter(sub => {
                const subDate = new Date(sub.submittedAt || sub.serverTimestamp);
                return subDate >= weekAgo;
            }).length;

            totalEl.textContent = total;
            todayEl.textContent = todayCount;
            weekEl.textContent = weekCount;
        }

        /**
         * Filter submissions based on search input
         */
        function filterSubmissions() {
            const searchTerm = document.getElementById('search-submissions').value.toLowerCase();

            filteredSubmissions = submissionsData.filter(submission => {
                return (submission.name || '').toLowerCase().includes(searchTerm) ||
                       (submission.id || '').toLowerCase().includes(searchTerm) ||
                       (submission.filename || '').toLowerCase().includes(searchTerm);
            });

            displaySubmissions(filteredSubmissions);
        }

        /**
         * Sort submissions based on selected criteria
         */
        function sortSubmissions() {
            const sortBy = document.getElementById('sort-submissions').value;

            filteredSubmissions.sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc':
                        return new Date(b.submittedAt || b.serverTimestamp) - new Date(a.submittedAt || a.serverTimestamp);
                    case 'date-asc':
                        return new Date(a.submittedAt || a.serverTimestamp) - new Date(b.submittedAt || b.serverTimestamp);
                    case 'name-asc':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'name-desc':
                        return (b.name || '').localeCompare(a.name || '');
                    default:
                        return 0;
                }
            });

            displaySubmissions(filteredSubmissions);
        }

        /**
         * Refresh a submission by reloading its data from the server and updating the table
         * @param {string} submissionId - The ID of the submission to refresh
         */
        async function refreshSubmission(submissionId) {
            try {
                console.log('Refreshing submission:', submissionId);
                const response = await authenticatedFetch(`/api/form-entries/${submissionId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                await response.json();
                await loadSubmissions();
            } catch (error) {
                console.error('Error refreshing submission:', error);
                alert('Failed to refresh submission: ' + error.message);
            }
        }

        /**
         * View detailed information about a specific submission
         * @param {string} submissionId - The ID of the submission to view
         */
        async function viewSubmission(submissionId) {
            try {
                console.log('Viewing submission:', submissionId);
                const response = await authenticatedFetch(`/api/form-entries/${submissionId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Submission details:', data);

                // Create and show detailed view modal
                showSubmissionModal(data.entry);

            } catch (error) {
                console.error('Error loading submission details:', error);
                alert('Failed to load submission details: ' + error.message);
            }
        }

        /**
         * Delete a submission after confirmation
         * @param {string} submissionId - The ID of the submission to delete
         */
        async function deleteSubmission(submissionId) {
            if (!confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('Deleting submission:', submissionId);
                const response = await authenticatedFetch(`/api/form-entries/${submissionId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Submission deleted:', data);

                // Remove from local data and refresh display
                submissionsData = submissionsData.filter(sub => sub.id !== submissionId);
                filteredSubmissions = filteredSubmissions.filter(sub => sub.id !== submissionId);

                displaySubmissions(filteredSubmissions);
                updateStats();

                // Show empty state if no submissions left
                if (submissionsData.length === 0) {
                    document.getElementById('submissions-list').style.display = 'none';
                    document.getElementById('no-submissions').style.display = 'block';
                }

            } catch (error) {
                console.error('Error deleting submission:', error);
                alert('Failed to delete submission: ' + error.message);
            }
        }

        /**
         * Show detailed submission information in a modal
         * @param {Object} submission - The submission data to display
         */
        function showSubmissionModal(submission) {
            const modalHtml = `
                <div id="submissionModal" class="modal show">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-file-alt"></i> Submission Details</h2>
                        </div>
                        <div class="modal-body">
                            <div class="confirmation-section">
                                <h3>Basic Information</h3>
                                <div class="confirmation-item">
                                    <span class="confirmation-label">Submission ID:</span>
                                    <span class="confirmation-value">${submission.id || 'N/A'}</span>
                                </div>
                                <div class="confirmation-item">
                                    <span class="confirmation-label">Submitted At:</span>
                                    <span class="confirmation-value">${submission.submittedAt || 'N/A'}</span>
                                </div>
                                <div class="confirmation-item">
                                    <span class="confirmation-label">Server Timestamp:</span>
                                    <span class="confirmation-value">${submission._metadata?.serverTimestamp || 'N/A'}</span>
                                </div>
                            </div>

                            <div class="confirmation-section">
                                <h3>Property Address</h3>
                                <div class="confirmation-item">
                                    <span class="confirmation-label">Full Address:</span>
                                    <span class="confirmation-value">${submission.Full_Address?.FullAddress || 'N/A'}</span>
                                </div>
                                <div class="confirmation-item">
                                    <span class="confirmation-label">Filing City:</span>
                                    <span class="confirmation-value">${submission['Filing city'] || 'N/A'}</span>
                                </div>
                                <div class="confirmation-item">
                                    <span class="confirmation-label">Filing County:</span>
                                    <span class="confirmation-value">${submission['Filing county'] || 'N/A'}</span>
                                </div>
                            </div>

                            <div class="confirmation-section">
                                <h3>Plaintiffs (${submission.PlaintiffDetails?.length || 0})</h3>
                                ${(submission.PlaintiffDetails || []).map((plaintiff, index) => `
                                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #00AEEF;">
                                        <h4 style="margin: 0 0 10px 0; color: #1F2A44;">Plaintiff ${index + 1}</h4>
                                        <div class="confirmation-item">
                                            <span class="confirmation-label">Name:</span>
                                            <span class="confirmation-value">${plaintiff.PlaintiffItemNumberName?.FirstAndLast || 'N/A'}</span>
                                        </div>
                                        <div class="confirmation-item">
                                            <span class="confirmation-label">Type:</span>
                                            <span class="confirmation-value">${plaintiff.PlaintiffItemNumberType || 'N/A'}</span>
                                        </div>
                                        <div class="confirmation-item">
                                            <span class="confirmation-label">Age Category:</span>
                                            <span class="confirmation-value">${plaintiff.PlaintiffItemNumberAgeCategory?.join(', ') || 'N/A'}</span>
                                        </div>
                                        <div class="confirmation-item">
                                            <span class="confirmation-label">Head of Household:</span>
                                            <span class="confirmation-value">${plaintiff.HeadOfHousehold ? 'Yes' : 'No'}</span>
                                        </div>
                                        ${plaintiff.PlaintiffItemNumberDiscovery?.Unit ? `
                                            <div class="confirmation-item">
                                                <span class="confirmation-label">Unit Number:</span>
                                                <span class="confirmation-value">${plaintiff.PlaintiffItemNumberDiscovery.Unit}</span>
                                            </div>
                                        ` : ''}

                                        ${generateDiscoveryIssuesHtml(plaintiff.PlaintiffItemNumberDiscovery)}
                                    </div>
                                `).join('')}
                            </div>

                            <div class="confirmation-section">
                                <h3>Defendants (${submission.DefendantDetails2?.length || 0})</h3>
                                ${(submission.DefendantDetails2 || []).map((defendant, index) => `
                                    <div style="margin-bottom: 15px; padding: 15px; background: #fff5f5; border-radius: 8px; border-left: 4px solid #DC3545;">
                                        <h4 style="margin: 0 0 10px 0; color: #1F2A44;">Defendant ${index + 1}</h4>
                                        <div class="confirmation-item">
                                            <span class="confirmation-label">Name:</span>
                                            <span class="confirmation-value">${defendant.DefendantItemNumberName?.FirstAndLast || 'N/A'}</span>
                                        </div>
                                        <div class="confirmation-item">
                                            <span class="confirmation-label">Entity Type:</span>
                                            <span class="confirmation-value">${defendant.DefendantItemNumberType || 'N/A'}</span>
                                        </div>
                                        <div class="confirmation-item">
                                            <span class="confirmation-label">Role:</span>
                                            <span class="confirmation-value">${defendant.DefendantItemNumberManagerOwner || 'N/A'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn" onclick="editSubmission('${submission.id || ''}')" style="background: #007bff;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button type="button" class="btn" onclick="closeSubmissionModal()" style="background: #6c757d;">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('submissionModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Close the submission details modal
         */
        function closeSubmissionModal() {
            const modal = document.getElementById('submissionModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Edit a submission by switching to edit mode
         * @param {string} submissionId - The ID of the submission to edit
         */
        async function editSubmission(submissionId) {
            try {
                console.log('Editing submission:', submissionId);

                // Fetch the submission data
                const response = await authenticatedFetch(`/api/form-entries/${submissionId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Close the view modal
                closeSubmissionModal();

                // Show the edit modal
                showEditSubmissionModal(data.entry, submissionId);

            } catch (error) {
                console.error('Error loading submission for editing:', error);
                alert('Failed to load submission for editing: ' + error.message);
            }
        }

        /**
         * Show edit submission modal with form fields
         * @param {Object} submission - The submission data to edit
         * @param {string} submissionId - The submission ID
         */
        function showEditSubmissionModal(submission, submissionId) {
            const modalHtml = `
                <div id="editSubmissionModal" class="modal show">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2><i class="fas fa-edit"></i> Edit Submission</h2>
                        </div>
                        <div class="modal-body">
                            <form id="editSubmissionForm">
                                <div class="confirmation-section">
                                    <h3>Property Address</h3>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="edit-property-address">Property Address (Line 1):</label>
                                            <input type="text" id="edit-property-address" name="property-address" value="${submission.Full_Address?.StreetAddress || ''}" placeholder="Enter street address">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-city">City:</label>
                                            <input type="text" id="edit-city" name="city" value="${submission.Full_Address?.City || ''}" placeholder="Enter city">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-state">State:</label>
                                            <input type="text" id="edit-state" name="state" value="${submission.Full_Address?.State || ''}" placeholder="Enter state">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-zip">ZIP Code:</label>
                                            <input type="text" id="edit-zip" name="zip-code" value="${submission.Full_Address?.PostalCode || ''}" placeholder="12345">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-filing-city">Filing City:</label>
                                            <input type="text" id="edit-filing-city" name="filing-city" value="${submission['Filing city'] || ''}" placeholder="Enter filing city">
                                        </div>
                                        <div class="form-group">
                                            <label for="edit-filing-county">Filing County:</label>
                                            <input type="text" id="edit-filing-county" name="filing-county" value="${submission['Filing county'] || ''}" placeholder="Enter filing county">
                                        </div>
                                    </div>
                                </div>

                                <div class="confirmation-section">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>Plaintiffs</h3>
                                        <button type="button" class="btn" onclick="editModalAddPlaintiff()" style="background: #28a745; font-size: 12px; padding: 6px 12px;">
                                            <i class="fas fa-plus"></i> Add Plaintiff
                                        </button>
                                    </div>
                                    <div id="edit-plaintiffs-container">
                                        ${generateEditPlaintiffsHtml(submission.PlaintiffDetails || [])}
                                    </div>
                                </div>

                                <div class="confirmation-section">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>Defendants</h3>
                                        <button type="button" class="btn" onclick="editModalAddDefendant()" style="background: #dc3545; font-size: 12px; padding: 6px 12px;">
                                            <i class="fas fa-plus"></i> Add Defendant
                                        </button>
                                    </div>
                                    <div id="edit-defendants-container">
                                        ${generateEditDefendantsHtml(submission.DefendantDetails2 || [])}
                                    </div>
                                </div>

                                <div class="confirmation-section">
                                    <h3>Issues by Head of Household</h3>
                                    <div id="edit-issues-container">
                                        ${generateEditAllIssuesHtml(submission.PlaintiffDetails || [])}
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn" onclick="saveSubmissionChanges('${submissionId}')" style="background: #28a745;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button type="button" class="btn" onclick="cancelEditSubmission('${submissionId}')" style="background: #6c757d;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modals
            const existingModal = document.getElementById('editSubmissionModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Generate HTML for editing plaintiffs
         * @param {Array} plaintiffs - Array of plaintiff objects
         * @returns {string} HTML string
         */
        function generateEditPlaintiffsHtml(plaintiffs) {
            return plaintiffs.map((plaintiff, index) => `
                <div class="edit-person-container" id="plaintiff-${index}" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #00AEEF;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #1F2A44;">Plaintiff ${index + 1}</h4>
                        <button type="button" class="btn" onclick="removePlaintiff(${index})" style="background: #dc3545; font-size: 12px; padding: 4px 8px;">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="edit-plaintiff-${index}-first">First Name:</label>
                            <input type="text" id="edit-plaintiff-${index}-first" name="plaintiff-${index}-first-name" value="${plaintiff.PlaintiffItemNumberName?.First || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-plaintiff-${index}-last">Last Name:</label>
                            <input type="text" id="edit-plaintiff-${index}-last" name="plaintiff-${index}-last-name" value="${plaintiff.PlaintiffItemNumberName?.Last || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-plaintiff-${index}-type">Plaintiff Type:</label>
                            <input type="text" id="edit-plaintiff-${index}-type" name="plaintiff-${index}-type" value="${plaintiff.PlaintiffItemNumberType || ''}" placeholder="e.g., Individual, Guardian, etc.">
                        </div>
                        <div class="form-group">
                            <label>Age Category:</label>
                            <div class="radio-group inline">
                                <div class="radio-item ${(plaintiff.PlaintiffItemNumberAgeCategory || []).includes('Adult') ? 'selected' : ''}" onclick="selectEditRadio('plaintiff-${index}-age-adult')">
                                    <input type="radio" id="edit-plaintiff-${index}-age-adult" name="plaintiff-${index}-age" value="adult" ${(plaintiff.PlaintiffItemNumberAgeCategory || []).includes('Adult') ? 'checked' : ''}>
                                    <label for="edit-plaintiff-${index}-age-adult">Adult</label>
                                </div>
                                <div class="radio-item ${(plaintiff.PlaintiffItemNumberAgeCategory || []).includes('Child') ? 'selected' : ''}" onclick="selectEditRadio('plaintiff-${index}-age-child')">
                                    <input type="radio" id="edit-plaintiff-${index}-age-child" name="plaintiff-${index}-age" value="child" ${(plaintiff.PlaintiffItemNumberAgeCategory || []).includes('Child') ? 'checked' : ''}>
                                    <label for="edit-plaintiff-${index}-age-child">Child</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Head of Household:</label>
                            <div class="radio-group inline">
                                <div class="radio-item ${plaintiff.HeadOfHousehold ? 'selected' : ''}" onclick="selectEditRadio('plaintiff-${index}-head-yes')">
                                    <input type="radio" id="edit-plaintiff-${index}-head-yes" name="plaintiff-${index}-head" value="yes" ${plaintiff.HeadOfHousehold ? 'checked' : ''}>
                                    <label for="edit-plaintiff-${index}-head-yes">Yes</label>
                                </div>
                                <div class="radio-item ${!plaintiff.HeadOfHousehold ? 'selected' : ''}" onclick="selectEditRadio('plaintiff-${index}-head-no')">
                                    <input type="radio" id="edit-plaintiff-${index}-head-no" name="plaintiff-${index}-head" value="no" ${!plaintiff.HeadOfHousehold ? 'checked' : ''}>
                                    <label for="edit-plaintiff-${index}-head-no">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group unit-field">
                            <label for="edit-plaintiff-${index}-unit">Unit Number (if any):</label>
                            <input type="text" id="edit-plaintiff-${index}-unit" name="plaintiff-${index}-unit" value="${plaintiff.PlaintiffItemNumberDiscovery?.Unit || ''}">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Generate HTML for editing defendants
         * @param {Array} defendants - Array of defendant objects
         * @returns {string} HTML string
         */
        function generateEditDefendantsHtml(defendants) {
            return defendants.map((defendant, index) => `
                <div class="edit-person-container" id="defendant-${index}" style="margin-bottom: 20px; padding: 15px; background: #fff5f5; border-radius: 8px; border-left: 4px solid #DC3545;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #1F2A44;">Defendant ${index + 1}</h4>
                        <button type="button" class="btn" onclick="removeDefendant(${index})" style="background: #dc3545; font-size: 12px; padding: 4px 8px;">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="edit-defendant-${index}-first">First Name:</label>
                            <input type="text" id="edit-defendant-${index}-first" name="defendant-${index}-first-name" value="${defendant.DefendantItemNumberName?.First || ''}" class="form-control">
                        </div>
                        <div class="col">
                            <label for="edit-defendant-${index}-last">Last Name:</label>
                            <input type="text" id="edit-defendant-${index}-last" name="defendant-${index}-last-name" value="${defendant.DefendantItemNumberName?.Last || ''}" class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="edit-defendant-${index}-entity">Entity Type:</label>
                            <input type="text" id="edit-defendant-${index}-entity" name="defendant-${index}-entity" value="${defendant.DefendantItemNumberType || ''}" class="form-control" placeholder="Individual, Corporation, Partnership, LLC, etc.">
                        </div>
                        <div class="col">
                            <label for="edit-defendant-${index}-role">Role:</label>
                            <select id="edit-defendant-${index}-role" name="defendant-${index}-role" class="form-control">
                                <option value="owner" ${defendant.DefendantItemNumberManagerOwner === 'Owner' ? 'selected' : ''}>Owner</option>
                                <option value="manager" ${defendant.DefendantItemNumberManagerOwner === 'Manager' ? 'selected' : ''}>Manager</option>
                            </select>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Save changes to the submission
         * @param {string} submissionId - The submission ID
         */
        async function saveSubmissionChanges(submissionId) {
            try {
                const form = document.getElementById('editSubmissionForm');
                const formData = new FormData(form);
                const updatedData = {};

                // Convert FormData to object
                for (const [key, value] of formData.entries()) {
                    if (value) {  // Only include non-empty values
                        updatedData[key] = value;
                    }
                }

                console.log('Saving submission changes:', updatedData);

                // Get current submission data first
                const currentResponse = await authenticatedFetch(`/api/form-entries/${submissionId}`);
                if (!currentResponse.ok) {
                    throw new Error(`HTTP error! status: ${currentResponse.status}`);
                }
                const currentData = await currentResponse.json();

                // Transform the form data using the same transformation function
                const transformedData = transformEditFormData(updatedData, currentData.entry);

                // Send PUT request
                const response = await authenticatedFetch(`/api/form-entries/${submissionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transformedData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Submission updated:', result);

                // Close edit modal
                const modal = document.getElementById('editSubmissionModal');
                if (modal) {
                    modal.remove();
                }

                // Refresh the submissions list
                await loadSubmissions();

                alert('Submission updated successfully!');

            } catch (error) {
                console.error('Error saving submission changes:', error);
                alert('Failed to save changes: ' + error.message);
            }
        }

        /**
         * Cancel editing and return to view mode
         * @param {string} submissionId - The submission ID
         */
        async function cancelEditSubmission(submissionId) {
            // Close edit modal
            const modal = document.getElementById('editSubmissionModal');
            if (modal) {
                modal.remove();
            }

            // Show the view modal again
            try {
                const response = await authenticatedFetch(`/api/form-entries/${submissionId}`);
                if (response.ok) {
                    const data = await response.json();
                    showSubmissionModal(data.entry);
                }
            } catch (error) {
                console.error('Error returning to view mode:', error);
            }
        }

        /**
         * Transform edit form data to match the expected structure
         * @param {Object} formData - The form data from the edit modal
         * @param {Object} originalData - The original submission data
         * @returns {Object} Transformed data
         */
        function transformEditFormData(formData, originalData) {
            // Start with original data to preserve complex structures
            const result = { ...originalData };

            // Update basic fields
            if (formData['filing-city']) {
                result['Filing city'] = formData['filing-city'];
            }
            if (formData['filing-county']) {
                result['Filing county'] = formData['filing-county'];
            }

            // Update address information
            if (formData['property-address'] || formData['city'] || formData['state'] || formData['zip-code']) {
                const streetAddress = formData['property-address'] || result.Full_Address?.StreetAddress || '';
                const city = formData['city'] || result.Full_Address?.City || '';
                const state = formData['state'] || result.Full_Address?.State || '';
                const zip = formData['zip-code'] || result.Full_Address?.PostalCode || '';

                const fullAddress = `${streetAddress}, ${city}, ${state} ${zip}`;
                const cityStateZip = `${city}, ${state} ${zip}`;

                result.Full_Address = {
                    ...result.Full_Address,
                    City: city,
                    CityStatePostalCode: cityStateZip,
                    FullAddress: fullAddress,
                    FullInternationalAddress: `${fullAddress}, United States`,
                    Line1: streetAddress,
                    PostalCode: zip,
                    State: state,
                    StreetAddress: streetAddress
                };
            }

            // Update plaintiffs - handle dynamic array
            const plaintiffCount = Math.max(
                Object.keys(formData).filter(key => key.includes('plaintiff-') && key.includes('-first-name')).length,
                result.PlaintiffDetails?.length || 0
            );

            // Create new plaintiffs array based on form data
            result.PlaintiffDetails = [];
            for (let index = 0; index < plaintiffCount; index++) {
                const firstKey = `plaintiff-${index}-first-name`;
                const lastKey = `plaintiff-${index}-last-name`;
                const typeKey = `plaintiff-${index}-type`;
                const ageKey = `plaintiff-${index}-age`;
                const unitKey = `plaintiff-${index}-unit`;
                const headKey = `plaintiff-${index}-head`;

                // Skip if no first name (empty plaintiff)
                if (!formData[firstKey]) continue;

                const plaintiff = {
                    Id: result.PlaintiffDetails?.[index]?.Id || generateShortId(),
                    PlaintiffItemNumberName: {
                        First: formData[firstKey] || '',
                        FirstAndLast: null,
                        Last: formData[lastKey] || '',
                        Middle: null,
                        MiddleInitial: null,
                        Prefix: null,
                        Suffix: null
                    },
                    PlaintiffItemNumberType: formData[typeKey] || 'Individual',
                    PlaintiffItemNumberAgeCategory: [formData[ageKey] === 'child' ? 'Child' : 'Adult'],
                    PlaintiffItemNumberDiscovery: result.PlaintiffDetails?.[index]?.PlaintiffItemNumberDiscovery || {},
                    HeadOfHousehold: formData[headKey] === 'yes',
                    ItemNumber: index + 1
                };

                // Set FirstAndLast
                if (plaintiff.PlaintiffItemNumberName.First && plaintiff.PlaintiffItemNumberName.Last) {
                    plaintiff.PlaintiffItemNumberName.FirstAndLast =
                        `${plaintiff.PlaintiffItemNumberName.First} ${plaintiff.PlaintiffItemNumberName.Last}`;
                }

                // Update unit
                if (formData[unitKey]) {
                    plaintiff.PlaintiffItemNumberDiscovery.Unit = formData[unitKey];
                }

                result.PlaintiffDetails.push(plaintiff);
            }

            // Update defendants - handle dynamic array
            const defendantCount = Math.max(
                Object.keys(formData).filter(key => key.includes('defendant-') && key.includes('-first-name')).length,
                result.DefendantDetails2?.length || 0
            );

            // Create new defendants array based on form data
            result.DefendantDetails2 = [];
            for (let index = 0; index < defendantCount; index++) {
                const firstKey = `defendant-${index}-first-name`;
                const lastKey = `defendant-${index}-last-name`;
                const entityKey = `defendant-${index}-entity`;
                const roleKey = `defendant-${index}-role`;

                // Skip if no first name (empty defendant)
                if (!formData[firstKey]) continue;

                const defendant = {
                    Id: result.DefendantDetails2?.[index]?.Id || generateShortId(),
                    DefendantItemNumberName: {
                        First: formData[firstKey] || '',
                        FirstAndLast: null,
                        Last: formData[lastKey] || '',
                        Middle: null,
                        MiddleInitial: null,
                        Prefix: null,
                        Suffix: null
                    },
                    DefendantItemNumberType: formData[entityKey] || 'Individual',
                    DefendantItemNumberManagerOwner: formData[roleKey] === 'manager' ? 'Manager' : 'Owner',
                    ItemNumber: index + 1
                };

                // Set FirstAndLast
                if (defendant.DefendantItemNumberName.First && defendant.DefendantItemNumberName.Last) {
                    defendant.DefendantItemNumberName.FirstAndLast =
                        `${defendant.DefendantItemNumberName.First} ${defendant.DefendantItemNumberName.Last}`;
                }

                result.DefendantDetails2.push(defendant);
            }

            // Update issues data for each head of household plaintiff
            if (result.PlaintiffDetails) {
                result.PlaintiffDetails.forEach((plaintiff, plaintiffIndex) => {
                    // Only update issues for head of household or first plaintiff
                    if (plaintiff.HeadOfHousehold || plaintiffIndex === 0) {
                        const issues = plaintiff.PlaintiffItemNumberDiscovery || {};

                        // Update issue flags for this specific plaintiff
                        issues.VerminIssue = formData[`edit-issue-${plaintiffIndex}-VerminIssue`] === 'true';
                        issues.InsectIssues = formData[`edit-issue-${plaintiffIndex}-InsectIssues`] === 'true';
                        issues.HVACIssues = formData[`edit-issue-${plaintiffIndex}-HVACIssues`] === 'true';
                        issues.ElectricalIssues = formData[`edit-issue-${plaintiffIndex}-ElectricalIssues`] === 'true';
                        issues.FireHazardIssues = formData[`edit-issue-${plaintiffIndex}-FireHazardIssues`] === 'true';
                        issues.AppliancesIssues = formData[`edit-issue-${plaintiffIndex}-AppliancesIssues`] === 'true';
                        issues.PlumbingIssues = formData[`edit-issue-${plaintiffIndex}-PlumbingIssues`] === 'true';
                        issues.CabinetsIssues = formData[`edit-issue-${plaintiffIndex}-CabinetsIssues`] === 'true';
                        issues.FlooringIssues = formData[`edit-issue-${plaintiffIndex}-FlooringIssues`] === 'true';
                        issues.WindowsIssues = formData[`edit-issue-${plaintiffIndex}-WindowsIssues`] === 'true';
                        issues.DoorIssues = formData[`edit-issue-${plaintiffIndex}-DoorIssues`] === 'true';
                        issues.StructureIssues = formData[`edit-issue-${plaintiffIndex}-StructureIssues`] === 'true';
                        issues.CommonAreasIssues = formData[`edit-issue-${plaintiffIndex}-CommonAreasIssues`] === 'true';
                        issues.TrashProblems = formData[`edit-issue-${plaintiffIndex}-TrashProblems`] === 'true';
                        issues.NuisanceIssues = formData[`edit-issue-${plaintiffIndex}-NuisanceIssues`] === 'true';
                        issues.HealthHazardIssues = formData[`edit-issue-${plaintiffIndex}-HealthHazardIssues`] === 'true';
                        issues.HarassmentIssues = formData[`edit-issue-${plaintiffIndex}-HarassmentIssues`] === 'true';
                        issues.NoticesIssues = formData[`edit-issue-${plaintiffIndex}-NoticesIssues`] === 'true';
                        issues.UtilityIssues = formData[`edit-issue-${plaintiffIndex}-UtilityIssues`] === 'true';
                        issues.Safety = formData[`edit-issue-${plaintiffIndex}-Safety`] === 'true';

                        // Update specific issue items for this plaintiff
                        const updateIssueItems = (key, fieldKey) => {
                            const itemsText = formData[`edit-issue-items-${plaintiffIndex}-${fieldKey}`];
                            issues[key] = itemsText ? itemsText.split(',').map(item => item.trim()).filter(item => item) : [];
                        };

                        updateIssueItems('Vermin', 'VerminIssue');
                        updateIssueItems('Insects', 'InsectIssues');
                        updateIssueItems('HVAC', 'HVACIssues');
                        updateIssueItems('Electrical', 'ElectricalIssues');
                        updateIssueItems('Fire Hazard', 'FireHazardIssues');
                        updateIssueItems('Appliances', 'AppliancesIssues');
                        updateIssueItems('Plumbing', 'PlumbingIssues');
                        updateIssueItems('Cabinets', 'CabinetsIssues');
                        updateIssueItems('Flooring', 'FlooringIssues');
                        updateIssueItems('Windows', 'WindowsIssues');
                        updateIssueItems('Doors', 'DoorIssues');
                        updateIssueItems('Structure', 'StructureIssues');
                        updateIssueItems('Common areas', 'CommonAreasIssues');
                        updateIssueItems('Select Trash Problems', 'TrashProblems');
                        updateIssueItems('Nuisance', 'NuisanceIssues');
                        updateIssueItems('Health hazard', 'HealthHazardIssues');
                        updateIssueItems('Harassment', 'HarassmentIssues');
                        updateIssueItems('Select Notices Issues', 'NoticesIssues');
                        updateIssueItems('Checkbox 44n6i', 'UtilityIssues');
                        updateIssueItems('Select Safety Issues', 'Safety');

                        // Update other boolean flags for this plaintiff
                        issues['Injury Issues'] = formData[`edit-issue-${plaintiffIndex}-InjuryIssues`] === 'true';
                        issues['Nonresponsive landlord Issues'] = formData[`edit-issue-${plaintiffIndex}-NonresponsiveLandlordIssues`] === 'true';
                        issues['Unauthorized entries'] = formData[`edit-issue-${plaintiffIndex}-UnauthorizedEntries`] === 'true';
                        issues['Stolen items'] = formData[`edit-issue-${plaintiffIndex}-StolenItems`] === 'true';
                        issues['Damaged items'] = formData[`edit-issue-${plaintiffIndex}-DamagedItems`] === 'true';
                        issues['Security Deposit'] = formData[`edit-issue-${plaintiffIndex}-SecurityDeposit`] === 'true';
                        issues['Age discrimination'] = formData[`edit-issue-${plaintiffIndex}-AgeDiscrimination`] === 'true';
                        issues['Racial Discrimination'] = formData[`edit-issue-${plaintiffIndex}-RacialDiscrimination`] === 'true';
                        issues['Disability discrimination'] = formData[`edit-issue-${plaintiffIndex}-DisabilityDiscrimination`] === 'true';
                        issues.GovernmentEntityContacted = formData[`edit-issue-${plaintiffIndex}-GovernmentEntityContacted`] === 'true';

                        plaintiff.PlaintiffItemNumberDiscovery = issues;
                    }
                });
            }

            return result;
        }

        /**
         * Generate short random ID
         */
        function generateShortId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        /**
         * Generate HTML for editing issues for all head of household plaintiffs
         * @param {Array} plaintiffs - Array of plaintiff objects
         * @returns {string} HTML string
         */
        function generateEditAllIssuesHtml(plaintiffs) {
            const headOfHouseholdPlaintiffs = plaintiffs.filter((plaintiff, index) => {
                return plaintiff.HeadOfHousehold || index === 0; // Include first plaintiff even if not explicitly marked as head
            });

            if (headOfHouseholdPlaintiffs.length === 0) {
                return '<p style="text-align: center; color: #666;">No head of household plaintiffs found.</p>';
            }

            return headOfHouseholdPlaintiffs.map((plaintiff, plaintiffIndex) => {
                const originalIndex = plaintiffs.indexOf(plaintiff);
                const issues = plaintiff.PlaintiffItemNumberDiscovery || {};

                return `
                    <div class="plaintiff-issues-section" style="margin-bottom: 30px; padding: 20px; border: 2px solid #00AEEF; border-radius: 12px; background: #f8fbff;">
                        <h4 style="margin: 0 0 20px 0; color: #1F2A44; display: flex; align-items: center;">
                            <i class="fas fa-user-tie" style="margin-right: 10px;"></i>
                            ${plaintiff.PlaintiffItemNumberName?.FirstAndLast || 'Unnamed Plaintiff'} - Issues
                            <span style="margin-left: 10px; font-size: 12px; background: #00AEEF; color: white; padding: 2px 8px; border-radius: 10px;">Head of Household</span>
                        </h4>
                        ${generateEditIssuesHtml(issues, originalIndex)}
                    </div>
                `;
            }).join('');
        }

        /**
         * Generate HTML for editing issues
         * @param {Object} issues - Issues object from plaintiff discovery data
         * @param {number} plaintiffIndex - Index of the plaintiff these issues belong to
         * @returns {string} HTML string
         */
        function generateEditIssuesHtml(issues, plaintiffIndex = 0) {
            const issueCategories = [
                { key: 'VerminIssue', label: 'Vermin Issues', items: issues.Vermin || [] },
                { key: 'InsectIssues', label: 'Insect Issues', items: issues.Insects || [] },
                { key: 'HVACIssues', label: 'HVAC Issues', items: issues.HVAC || [] },
                { key: 'ElectricalIssues', label: 'Electrical Issues', items: issues.Electrical || [] },
                { key: 'FireHazardIssues', label: 'Fire Hazard Issues', items: issues['Fire Hazard'] || [] },
                { key: 'AppliancesIssues', label: 'Appliances Issues', items: issues.Appliances || [] },
                { key: 'PlumbingIssues', label: 'Plumbing Issues', items: issues.Plumbing || [] },
                { key: 'CabinetsIssues', label: 'Cabinets Issues', items: issues.Cabinets || [] },
                { key: 'FlooringIssues', label: 'Flooring Issues', items: issues.Flooring || [] },
                { key: 'WindowsIssues', label: 'Windows Issues', items: issues.Windows || [] },
                { key: 'DoorIssues', label: 'Door Issues', items: issues.Doors || [] },
                { key: 'StructureIssues', label: 'Structure Issues', items: issues.Structure || [] },
                { key: 'CommonAreasIssues', label: 'Common Areas Issues', items: issues['Common areas'] || [] },
                { key: 'TrashProblems', label: 'Trash Problems', items: issues['Select Trash Problems'] || [] },
                { key: 'NuisanceIssues', label: 'Nuisance Issues', items: issues.Nuisance || [] },
                { key: 'HealthHazardIssues', label: 'Health Hazard Issues', items: issues['Health hazard'] || [] },
                { key: 'HarassmentIssues', label: 'Harassment Issues', items: issues.Harassment || [] },
                { key: 'NoticesIssues', label: 'Notices Issues', items: issues['Select Notices Issues'] || [] },
                { key: 'UtilityIssues', label: 'Utility Issues', items: issues['Checkbox 44n6i'] || [] },
                { key: 'Safety', label: 'Safety Issues', items: issues['Select Safety Issues'] || [] }
            ];

            return `
                <div class="issues-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    ${issueCategories.map(category => `
                        <div class="issue-category" style="border: 1px solid #E2E8F0; border-radius: 8px; padding: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #2D3748;">${category.label}</h4>
                            <div>
                                <label>
                                    <input type="checkbox" name="edit-issue-${plaintiffIndex}-${category.key}" value="true" ${issues[category.key] ? 'checked' : ''}>
                                    Has ${category.label}
                                </label>
                            </div>
                            <div style="margin-top: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">Specific Issues (comma-separated):</label>
                                <textarea name="edit-issue-items-${plaintiffIndex}-${category.key}" class="form-control" rows="2" placeholder="Enter specific issues...">${category.items.join(', ')}</textarea>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-top: 20px;">
                    <h4>Additional Issues</h4>
                    <div class="row">
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-InjuryIssues" value="true" ${issues['Injury Issues'] ? 'checked' : ''}>
                                Injury Issues
                            </label>
                        </div>
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-NonresponsiveLandlordIssues" value="true" ${issues['Nonresponsive landlord Issues'] ? 'checked' : ''}>
                                Nonresponsive Landlord Issues
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-UnauthorizedEntries" value="true" ${issues['Unauthorized entries'] ? 'checked' : ''}>
                                Unauthorized Entries
                            </label>
                        </div>
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-StolenItems" value="true" ${issues['Stolen items'] ? 'checked' : ''}>
                                Stolen Items
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-DamagedItems" value="true" ${issues['Damaged items'] ? 'checked' : ''}>
                                Damaged Items
                            </label>
                        </div>
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-SecurityDeposit" value="true" ${issues['Security Deposit'] ? 'checked' : ''}>
                                Security Deposit Issues
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-AgeDiscrimination" value="true" ${issues['Age discrimination'] ? 'checked' : ''}>
                                Age Discrimination
                            </label>
                        </div>
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-RacialDiscrimination" value="true" ${issues['Racial Discrimination'] ? 'checked' : ''}>
                                Racial Discrimination
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-DisabilityDiscrimination" value="true" ${issues['Disability discrimination'] ? 'checked' : ''}>
                                Disability Discrimination
                            </label>
                        </div>
                        <div class="col">
                            <label>
                                <input type="checkbox" name="edit-issue-${plaintiffIndex}-GovernmentEntityContacted" value="true" ${issues['GovernmentEntityContacted'] ? 'checked' : ''}>
                                Government Entity Contacted
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Add a new plaintiff
         */
        function editModalAddPlaintiff() {
            const container = document.getElementById('edit-plaintiffs-container');
            const currentPlaintiffs = container.children.length;
            const newIndex = currentPlaintiffs;

            const newPlaintiffHtml = `
                <div class="edit-person-container" id="plaintiff-${newIndex}" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #00AEEF;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #1F2A44;">Plaintiff ${newIndex + 1}</h4>
                        <button type="button" class="btn" onclick="editModalRemovePlaintiff(${newIndex})" style="background: #dc3545; font-size: 12px; padding: 4px 8px;">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="edit-plaintiff-${newIndex}-first">First Name:</label>
                            <input type="text" id="edit-plaintiff-${newIndex}-first" name="plaintiff-${newIndex}-first-name" value="" class="form-control">
                        </div>
                        <div class="col">
                            <label for="edit-plaintiff-${newIndex}-last">Last Name:</label>
                            <input type="text" id="edit-plaintiff-${newIndex}-last" name="plaintiff-${newIndex}-last-name" value="" class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="edit-plaintiff-${newIndex}-type">Type:</label>
                            <input type="text" id="edit-plaintiff-${newIndex}-type" name="plaintiff-${newIndex}-type" value="Individual" class="form-control" placeholder="Individual, Corporation, Partnership, LLC, etc.">
                        </div>
                        <div class="col">
                            <label for="edit-plaintiff-${newIndex}-age">Age Category:</label>
                            <select id="edit-plaintiff-${newIndex}-age" name="plaintiff-${newIndex}-age" class="form-control">
                                <option value="adult" selected>Adult</option>
                                <option value="child">Child</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="edit-plaintiff-${newIndex}-unit">Unit Number:</label>
                            <input type="text" id="edit-plaintiff-${newIndex}-unit" name="plaintiff-${newIndex}-unit" value="" class="form-control">
                        </div>
                        <div class="col">
                            <label>
                                <input type="checkbox" name="plaintiff-${newIndex}-head" value="yes"> Head of Household
                            </label>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', newPlaintiffHtml);
        }

        /**
         * Remove a plaintiff (Edit Modal version)
         * @param {number} index - Index of plaintiff to remove
         */
        function editModalRemovePlaintiff(index) {
            const element = document.getElementById(`plaintiff-${index}`);
            if (element) {
                element.remove();
            }
            editModalRenumberPlaintiffs();
        }

        /**
         * Add a new defendant
         */
        function editModalAddDefendant() {
            const container = document.getElementById('edit-defendants-container');
            const currentDefendants = container.children.length;
            const newIndex = currentDefendants;

            const newDefendantHtml = `
                <div class="edit-person-container" id="defendant-${newIndex}" style="margin-bottom: 20px; padding: 15px; background: #fff5f5; border-radius: 8px; border-left: 4px solid #DC3545;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #1F2A44;">Defendant ${newIndex + 1}</h4>
                        <button type="button" class="btn" onclick="editModalRemoveDefendant(${newIndex})" style="background: #dc3545; font-size: 12px; padding: 4px 8px;">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="edit-defendant-${newIndex}-first">First Name:</label>
                            <input type="text" id="edit-defendant-${newIndex}-first" name="defendant-${newIndex}-first-name" value="" class="form-control">
                        </div>
                        <div class="col">
                            <label for="edit-defendant-${newIndex}-last">Last Name:</label>
                            <input type="text" id="edit-defendant-${newIndex}-last" name="defendant-${newIndex}-last-name" value="" class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label for="edit-defendant-${newIndex}-entity">Entity Type:</label>
                            <input type="text" id="edit-defendant-${newIndex}-entity" name="defendant-${newIndex}-entity" value="Individual" class="form-control" placeholder="Individual, Corporation, Partnership, LLC, etc.">
                        </div>
                        <div class="col">
                            <label for="edit-defendant-${newIndex}-role">Role:</label>
                            <select id="edit-defendant-${newIndex}-role" name="defendant-${newIndex}-role" class="form-control">
                                <option value="owner" selected>Owner</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', newDefendantHtml);
        }

        /**
         * Remove a defendant (Edit Modal version)
         * @param {number} index - Index of defendant to remove
         */
        function editModalRemoveDefendant(index) {
            const element = document.getElementById(`defendant-${index}`);
            if (element) {
                element.remove();
            }
            editModalRenumberDefendants();
        }

        /**
         * Renumber plaintiffs after removal (Edit Modal version)
         */
        function editModalRenumberPlaintiffs() {
            const container = document.getElementById('edit-plaintiffs-container');
            const plaintiffs = container.children;

            Array.from(plaintiffs).forEach((plaintiff, newIndex) => {
                plaintiff.id = `plaintiff-${newIndex}`;
                const h4 = plaintiff.querySelector('h4');
                if (h4) h4.textContent = `Plaintiff ${newIndex + 1}`;

                // Update all input/select names and IDs
                const inputs = plaintiff.querySelectorAll('input, select');
                inputs.forEach(input => {
                    const oldName = input.name;
                    const oldId = input.id;
                    if (oldName && oldName.includes('plaintiff-')) {
                        input.name = oldName.replace(/plaintiff-\d+/, `plaintiff-${newIndex}`);
                    }
                    if (oldId && oldId.includes('plaintiff-')) {
                        input.id = oldId.replace(/plaintiff-\d+/, `plaintiff-${newIndex}`);
                    }
                });

                // Update labels
                const labels = plaintiff.querySelectorAll('label[for]');
                labels.forEach(label => {
                    const oldFor = label.getAttribute('for');
                    if (oldFor && oldFor.includes('plaintiff-')) {
                        label.setAttribute('for', oldFor.replace(/plaintiff-\d+/, `plaintiff-${newIndex}`));
                    }
                });

                // Update remove button onclick
                const removeBtn = plaintiff.querySelector('button[onclick*="removePlaintiff"]');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `editModalRemovePlaintiff(${newIndex})`);
                }
            });
        }

        /**
         * Renumber defendants after removal (Edit Modal version)
         */
        function editModalRenumberDefendants() {
            const container = document.getElementById('edit-defendants-container');
            const defendants = container.children;

            Array.from(defendants).forEach((defendant, newIndex) => {
                defendant.id = `defendant-${newIndex}`;
                const h4 = defendant.querySelector('h4');
                if (h4) h4.textContent = `Defendant ${newIndex + 1}`;

                // Update all input/select names and IDs
                const inputs = defendant.querySelectorAll('input, select');
                inputs.forEach(input => {
                    const oldName = input.name;
                    const oldId = input.id;
                    if (oldName && oldName.includes('defendant-')) {
                        input.name = oldName.replace(/defendant-\d+/, `defendant-${newIndex}`);
                    }
                    if (oldId && oldId.includes('defendant-')) {
                        input.id = oldId.replace(/defendant-\d+/, `defendant-${newIndex}`);
                    }
                });

                // Update labels
                const labels = defendant.querySelectorAll('label[for]');
                labels.forEach(label => {
                    const oldFor = label.getAttribute('for');
                    if (oldFor && oldFor.includes('defendant-')) {
                        label.setAttribute('for', oldFor.replace(/defendant-\d+/, `defendant-${newIndex}`));
                    }
                });

                // Update remove button onclick
                const removeBtn = defendant.querySelector('button[onclick*="removeDefendant"]');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `editModalRemoveDefendant(${newIndex})`);
                }
            });
        }

        /**
         * Clear all submissions after confirmation
         */
        async function clearAllSubmissions() {
            if (!confirm('Are you sure you want to delete ALL submissions? This action cannot be undone and will permanently remove all form data.')) {
                return;
            }

            if (!confirm('This will permanently delete all submissions. Are you absolutely sure you want to continue?')) {
                return;
            }

            try {
                console.log('Clearing all submissions...');
                const response = await authenticatedFetch('/api/form-entries/clear-all', {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('All submissions cleared:', data);

                // Clear local data
                submissionsData = [];
                filteredSubmissions = [];

                // Update UI
                displaySubmissions(filteredSubmissions);
                updateStats();

                // Show empty state if no submissions
                if (filteredSubmissions.length === 0) {
                    document.getElementById('submissions-list').innerHTML = '<div class="no-submissions"><i class="fas fa-inbox"></i><h3>No Submissions</h3><p>No form submissions have been created yet. Use the "Create Form" tab to submit your first entry.</p></div>';
                }

                alert(`Successfully cleared ${data.deletedCount || 0} submissions.`);

            } catch (error) {
                console.error('Error clearing all submissions:', error);
                alert('Failed to clear submissions: ' + error.message);
            }
        }

        /**
         * Generate HTML for discovery issues in a structured format
         * @param {Object} discovery - The discovery object containing all issue categories
         * @returns {string} HTML string for displaying discovery issues
         */
        function generateDiscoveryIssuesHtml(discovery) {
            if (!discovery) return '';

            const issueCategories = [
                { flag: 'VerminIssue', items: 'Vermin', title: 'Vermin Issues' },
                { flag: 'InsectIssues', items: 'Insects', title: 'Insect Issues' },
                { flag: 'HVACIssues', items: 'HVAC', title: 'HVAC Issues' },
                { flag: 'ElectricalIssues', items: 'Electrical', title: 'Electrical Issues' },
                { flag: 'FireHazardIssues', items: 'Fire Hazard', title: 'Fire Hazard Issues' },
                { flag: 'GovernmentEntityContacted', items: 'Specific Government Entity Contacted', title: 'Government Entities Contacted' },
                { flag: 'AppliancesIssues', items: 'Appliances', title: 'Appliance Issues' },
                { flag: 'PlumbingIssues', items: 'Plumbing', title: 'Plumbing Issues' },
                { flag: 'CabinetsIssues', items: 'Cabinets', title: 'Cabinet Issues' },
                { flag: 'FlooringIssues', items: 'Flooring', title: 'Flooring Issues' },
                { flag: 'WindowsIssues', items: 'Windows', title: 'Window Issues' },
                { flag: 'DoorIssues', items: 'Doors', title: 'Door Issues' },
                { flag: 'StructureIssues', items: 'Structure', title: 'Structural Issues' },
                { flag: 'CommonAreasIssues', items: 'Common areas', title: 'Common Area Issues' },
                { flag: 'TrashProblems', items: 'Select Trash Problems', title: 'Trash Problems' },
                { flag: 'NuisanceIssues', items: 'Nuisance', title: 'Nuisance Issues' },
                { flag: 'HealthHazardIssues', items: 'Health hazard', title: 'Health Hazard Issues' },
                { flag: 'HarassmentIssues', items: 'Harassment', title: 'Harassment Issues' },
                { flag: 'NoticesIssues', items: 'Select Notices Issues', title: 'Notice Issues' },
                { flag: 'UtilityIssues', items: 'Checkbox 44n6i', title: 'Utility Issues' },
                { flag: 'Safety', items: 'Select Safety Issues', title: 'Safety Issues' }
            ];

            const directIssues = [
                { flag: 'Injury Issues', title: 'Injury Issues' },
                { flag: 'Nonresponsive landlord Issues', title: 'Nonresponsive Landlord Issues' },
                { flag: 'Unauthorized entries', title: 'Unauthorized Entries' },
                { flag: 'Stolen items', title: 'Stolen Items' },
                { flag: 'Damaged items', title: 'Damaged Items' },
                { flag: 'Age discrimination', title: 'Age Discrimination' },
                { flag: 'Racial Discrimination', title: 'Racial Discrimination' },
                { flag: 'Disability discrimination', title: 'Disability Discrimination' },
                { flag: 'Security Deposit', title: 'Security Deposit Issues' }
            ];

            let hasAnyIssues = false;
            let html = '<div style="margin-top: 15px;"><h5 style="margin: 0 0 10px 0; color: #1F2A44; font-size: 1rem;">Discovery Issues</h5>';

            // Process categorized issues (those with arrays of specific items)
            const categorizedIssuesHtml = issueCategories.map(category => {
                if (discovery[category.flag] && discovery[category.items] && discovery[category.items].length > 0) {
                    hasAnyIssues = true;
                    return `
                        <div style="margin-bottom: 12px; padding: 10px; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <strong style="color: #1F2A44; font-size: 0.9rem;">${category.title}:</strong>
                            <div style="margin-top: 5px; display: flex; flex-wrap: wrap; gap: 5px;">
                                ${discovery[category.items].map(item =>
                                    `<span style="background: #00AEEF; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">${item}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }
                return '';
            }).filter(Boolean).join('');

            // Process direct boolean issues
            const directIssuesHtml = directIssues.filter(issue => discovery[issue.flag] === true).map(issue => {
                hasAnyIssues = true;
                return `
                    <div style="margin-bottom: 8px; padding: 8px; background: #fff; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <span style="color: #1F2A44; font-size: 0.9rem; font-weight: 500;">${issue.title}</span>
                        <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px;">Yes</span>
                    </div>
                `;
            }).join('');

            html += categorizedIssuesHtml + directIssuesHtml;

            if (!hasAnyIssues) {
                html += '<div style="padding: 10px; background: #f8f9fa; border-radius: 6px; color: #666; font-style: italic;">No specific issues reported</div>';
            }

            html += '</div>';
            return html;
        }
    </script>
    
    <!-- SSE Progress Tracking Modules -->
    <script src="js/progress-state.js?v=2"></script>
    <script src="js/sse-client.js?v=3"></script>
    <script src="js/sse-manager.js?v=1"></script>
    <script src="js/form-submission.js?v=8"></script>
</body>
</html>
